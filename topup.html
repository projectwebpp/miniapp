<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô - ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏°‡∏ó‡∏≠‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-100">
    <!-- Mobile Header -->
    <div class="mobile-header p-4 flex items-center space-x-4">
        <button onclick="goBack()" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="page-title">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h1>
        <div class="w-10"></div> <!-- Spacer for center alignment -->
    </div>

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <i class="fas fa-wallet text-6xl text-blue-500 animate-pulse mb-4"></i>
            <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="hidden page-container p-4">
        <div class="max-w-md mx-auto">
            <!-- Process Steps -->
            <div class="bg-white rounded-lg shadow p-4 mb-6 card-hover">
                <div class="process-steps mb-6">
                    <div id="step1" class="step active">
                        <div class="step-number">1</div>
                        <div class="step-text">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    </div>
                    <div id="step2" class="step">
                        <div class="step-number">2</div>
                        <div class="step-text">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</div>
                    </div>
                    <div id="step3" class="step">
                        <div class="step-number">3</div>
                        <div class="step-text">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</div>
                    </div>
                </div>
            </div>

            <!-- Current Balance -->
            <div class="bg-white rounded-lg shadow p-4 mb-6 card-hover">
                <div class="text-center">
                    <p class="text-gray-500 text-sm mb-1">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                    <p id="currentBalance" class="text-2xl font-bold text-blue-600">‡∏ø0.00</p>
                </div>
            </div>

            <!-- Top-up Form -->
            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <h2 class="text-xl font-bold mb-6 text-center">
                    <i class="fas fa-plus-circle mr-2 text-blue-500"></i>‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤
                </h2>
                
                <div class="space-y-4">
                    <!-- Amount -->
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <i class="fas fa-money-bill-wave mr-1"></i>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)
                        </label>
                        <input type="number" id="topupAmount" step="0.01" min="100" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó"
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó</p>
                    </div>

                    <!-- Bank Selection -->
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <i class="fas fa-university mr-1"></i>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
                        </label>
                        <select id="topupBank" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="updateAccountNumber()">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>

                    <!-- Account Number -->
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <i class="fas fa-credit-card mr-1"></i>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                        </label>
                        <div class="relative">
                            <input type="text" id="topupAccountNumber" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"
                                   class="w-full p-3 border rounded-lg bg-gray-50" readonly>
                            <button onclick="copyAccountNumber()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-blue-600 hover:text-blue-800">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</p>
                    </div>

                    <!-- Slip Upload -->
                    <div id="slipUploadSection">
                        <label class="block text-sm font-medium mb-2">
                            <i class="fas fa-upload mr-1"></i>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                        </label>
                        <label id="topupSlipLabel" for="topupSlip" class="block w-full p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition text-center">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
                            <p class="text-xs text-gray-500 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB</p>
                        </label>
                        <input type="file" id="topupSlip" accept="image/jpeg,image/png" class="hidden">
                        
                        <div id="filePreview" class="mt-3 hidden">
                            <p id="topupFileName" class="text-sm text-gray-600 mb-2"></p>
                            <img id="previewImage" src="" alt="Preview" class="file-preview mt-2 w-full max-h-48 object-cover rounded-lg">
                            <button onclick="removeSlip()" class="mt-2 text-sm text-red-600 hover:text-red-800 btn-animate">
                                <i class="fas fa-trash-alt mr-1"></i>‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå
                            </button>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h4 class="font-semibold text-yellow-800 mb-2">
                            <i class="fas fa-info-circle mr-1"></i>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô
                        </h4>
                        <ol class="text-sm text-yellow-700 space-y-1">
                            <li>1. ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</li>
                            <li>2. ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</li>
                            <li>3. ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</li>
                            <li>4. ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö 5-10 ‡∏ô‡∏≤‡∏ó‡∏µ</li>
                        </ol>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex space-x-3 mt-6">
                    <button id="submitTopupBtn" onclick="submitTopup()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition disabled:opacity-50 disabled:cursor-not-allowed btn-animate">
                        <span id="submitText">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span>
                        <span id="submitSpinner" class="spinner"></span>
                    </button>
                    <button onclick="goBack()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition btn-animate">
                        <i class="fas fa-times mr-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script>
        // Global Variables
        let userData = {};
        let walletData = { balance: 0 };

        // Go back function
        function goBack() {
            window.history.back();
        }

        // Update bank dropdowns in the UI
        function updateBankDropdowns() {
            const bankSelect = document.getElementById('topupBank');
            
            if (bankSelect) {
                // Clear existing options
                bankSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ --</option>';
                
                // Add new options based on BANK_ACCOUNTS
                for (const [bankName, accountNumber] of Object.entries(BANK_ACCOUNTS)) {
                    const option = document.createElement('option');
                    option.value = bankName;
                    option.textContent = bankName;
                    bankSelect.appendChild(option);
                }
            }
        }

        // Update account number based on bank selection
        function updateAccountNumber() {
            const bankSelect = document.getElementById('topupBank');
            const accountNumberField = document.getElementById('topupAccountNumber');
            
            if (bankSelect && accountNumberField) {
                const selectedBank = bankSelect.value;
                accountNumberField.value = BANK_ACCOUNTS[selectedBank] || '';
                updateProcessSteps(selectedBank ? 2 : 1);
            }
        }

        // Copy account number to clipboard
        function copyAccountNumber() {
            const accountNumber = document.getElementById('topupAccountNumber').value;
            if (accountNumber) {
                navigator.clipboard.writeText(accountNumber).then(() => {
                    // Show feedback
                    const copyBtn = event.target.closest('button');
                    const originalIcon = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check text-green-600"></i>';
                    setTimeout(() => {
                        copyBtn.innerHTML = originalIcon;
                    }, 2000);
                    
                    // Show toast notification
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                        text: '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß',
                        timer: 1500,
                        showConfirmButton: false,
                        toast: true,
                        position: 'top-end'
                    });
                }).catch(() => {
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ', 'error');
                });
            }
        }

        // Function to update process steps
        function updateProcessSteps(step) {
            // Reset all steps
            document.querySelectorAll('.step').forEach(el => {
                el.classList.remove('active', 'completed');
            });

            // Mark completed steps
            for (let i = 1; i < step; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
            }

            // Mark current step
            if (step <= 3) {
                document.getElementById(`step${step}`).classList.add('active');
            }
        }

        // Function to remove slip
        function removeSlip() {
            document.getElementById('topupSlip').value = '';
            document.getElementById('filePreview').classList.add('hidden');
            document.getElementById('previewImage').src = '';
            document.getElementById('topupFileName').textContent = '';
            updateProcessSteps(2);
        }

        // Submit top-up request - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
        async function submitTopup() {
            const amount = parseFloat(document.getElementById('topupAmount').value);
            const bank = document.getElementById('topupBank').value;
            const account = document.getElementById('topupAccountNumber').value;
            const slipFile = document.getElementById('topupSlip').files[0];

            // Validate inputs
            if (!amount || amount < 100) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏° (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó)', 'error');
                return;
            }
            if (!bank) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£', 'error');
                return;
            }
            if (!slipFile) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'error');
                return;
            }

            // Show loading
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // Use FileReader like in the example
                let fr = new FileReader();
                fr.addEventListener('loadend', () => {
                    let res = fr.result;
                    let spt = res.split("base64,")[1];
                    
                    // Prepare payload using the same structure as example
                    let obj = {
                        action: 'topup',
                        userId: userData.userId,
                        amount: amount,
                        bank: bank,
                        account: account,
                        base64: spt,
                        type: slipFile.type,
                        name: slipFile.name
                    };

                    // Send data using the same method as example (without Content-Type header)
                    fetch(API_URL, {
                        method: "POST",
                        body: JSON.stringify(obj)
                    })
                    .then(r => r.text())
                    .then(data => {
                        console.log('Response:', data);
                        
                        // ‡∏õ‡∏¥‡∏î Loading ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                        Swal.fire({
                            icon: 'success',
                            title: 'üéâ ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            html: `
                                <div class="text-center space-y-3">
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <p class="text-lg font-semibold text-green-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</p>
                                        <hr class="my-2">
                                        <div class="text-left space-y-1">
                                            <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</strong> ‡∏ø${formatCurrency(amount)}</p>
                                            <p><strong>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> ${bank}</p>
                                            <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> ${account}</p>
                                        </div>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <p class="text-sm text-blue-800">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 5-10 ‡∏ô‡∏≤‡∏ó‡∏µ</p>
                                        <p class="text-sm text-blue-800">üì± ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE</p>
                                    </div>
                                </div>
                            `,
                            confirmButtonText: '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å',
                            confirmButtonColor: '#10b981',
                            allowOutsideClick: false
                        });
                        
                        window.location.href = 'index.html';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message
                        });
                    });
                });

                if (slipFile) {
                    fr.readAsDataURL(slipFile);
                } else {
                    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ validate ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå)
                    let obj = {
                        action: 'topup',
                        userId: userData.userId,
                        amount: amount,
                        bank: bank,
                        account: account,
                        base64: null,
                        type: null,
                        name: null
                    };
                    
                    fetch(API_URL, {
                        method: "POST",
                        body: JSON.stringify(obj)
                    })
                    .then(r => r.text())
                    .then(data => {
                        Swal.fire({
                            icon: 'success',
                            title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        console.log(data);
                       // window.location.href = 'index.html';
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message
                        });
                        console.error('Error:', error);
                    });
                }

            } catch (error) {
                console.error('Error:', error);
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô', 'error');
            }
        }

        // Load Wallet Data
        async function loadWalletData() {
            try {
                const response = await fetch(`${API_URL}?action=getWallet&userId=${userData.userId}`);
                const data = await response.json();
                if (data.success) {
                    walletData.balance = data.balance || 0;
                    document.getElementById('currentBalance').textContent = '‡∏ø' + formatCurrency(walletData.balance);
                }
            } catch (error) {
                console.error('Error loading wallet data:', error);
            }
        }

        // Initialize LIFF
        window.onload = async function() {
            try {
                await liff.init({ liffId: LIFF_ID });
                await fetchBankAccounts();
                if (liff.isLoggedIn()) {
                    initApp();
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error('LIFF init failed:', err);
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF ‡πÑ‡∏î‡πâ', 'error');
            }
        };

        // Initialize App
        async function initApp() {
            try {
                const profile = await liff.getProfile();
                userData = {
                    userId: profile.userId,
                    name: profile.displayName,
                    picture: profile.pictureUrl
                };

                await loadWalletData();
                updateBankDropdowns();
                updateProcessSteps(1);

                // Set up file input
                const fileInput = document.getElementById('topupSlip');
                const fileLabel = document.getElementById('topupSlipLabel');
                const filePreview = document.getElementById('filePreview');
                const fileName = document.getElementById('topupFileName');
                const previewImage = document.getElementById('previewImage');

                // Real-time amount validation
                document.getElementById('topupAmount').addEventListener('input', function() {
                    const amount = parseFloat(this.value) || 0;
                    const submitBtn = document.getElementById('submitTopupBtn');

                    if (amount < 100) {
                        submitBtn.disabled = true;
                        this.style.borderColor = '#ef4444';
                    } else {
                        submitBtn.disabled = false;
                        this.style.borderColor = '#10b981';
                    }
                });

                // File input change handler
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];

                        // Validate file type
                        if (!ALLOWED_FILE_TYPES.includes(file.type)) {
                            Swal.fire({
                                icon: 'error',
                                title: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                                text: '‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û JPG ‡∏´‡∏£‡∏∑‡∏≠ PNG ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                                confirmButtonColor: '#3b82f6'
                            });
                            fileInput.value = '';
                            return;
                        }

                        // Validate file size
                        if (file.size > MAX_FILE_SIZE) {
                            Swal.fire({
                                icon: 'error',
                                title: '‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
                                text: '‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB',
                                confirmButtonColor: '#3b82f6'
                            });
                            fileInput.value = '';
                            return;
                        }

                        // Show file preview
                        fileName.textContent = file.name;
                        filePreview.classList.remove('hidden');
                        updateProcessSteps(3);

                        // Show preview image
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            previewImage.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Drag and drop functionality
                fileLabel.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    fileLabel.classList.add('border-blue-500', 'bg-blue-50');
                    fileLabel.querySelector('p').textContent = '‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î';
                });

                fileLabel.addEventListener('dragleave', function() {
                    fileLabel.classList.remove('border-blue-500', 'bg-blue-50');
                    fileLabel.querySelector('p').textContent = '‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
                });

                fileLabel.addEventListener('drop', function(e) {
                    e.preventDefault();
                    fileLabel.classList.remove('border-blue-500', 'bg-blue-50');
                    fileLabel.querySelector('p').textContent = '‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';

                    if (e.dataTransfer.files.length > 0) {
                        const file = e.dataTransfer.files[0];

                        // Validate file type
                        if (!ALLOWED_FILE_TYPES.includes(file.type)) {
                            Swal.fire({
                                icon: 'error',
                                title: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                                text: '‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û JPG ‡∏´‡∏£‡∏∑‡∏≠ PNG ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                                confirmButtonColor: '#3b82f6'
                            });
                            return;
                        }

                        // Validate file size
                        if (file.size > MAX_FILE_SIZE) {
                            Swal.fire({
                                icon: 'error',
                                title: '‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
                                text: '‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB',
                                confirmButtonColor: '#3b82f6'
                            });
                            return;
                        }

                        // Set file to input
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;

                        // Trigger change event
                        const event = new Event('change');
                        fileInput.dispatchEvent(event);
                    }
                });

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            } catch (error) {
                console.error('Error initializing app:', error);
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡πÑ‡∏î‡πâ', 'error');
            }
        }
    </script>
</body>
</html>

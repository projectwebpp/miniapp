<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เติมเงิน - ระบบออมทอง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-100">
    <!-- Mobile Header -->
    <div class="mobile-header p-4 flex items-center space-x-4">
        <button onclick="goBack()" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="page-title">เติมเงิน</h1>
        <div class="w-10"></div> <!-- Spacer for center alignment -->
    </div>

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <i class="fas fa-wallet text-6xl text-blue-500 animate-pulse mb-4"></i>
            <p class="text-gray-600">กำลังโหลด...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="hidden page-container p-4">
        <div class="max-w-md mx-auto">
            <!-- Process Steps -->
            <div class="bg-white rounded-lg shadow p-4 mb-6 card-hover">
                <div class="process-steps mb-6">
                    <div id="step1" class="step active">
                        <div class="step-number">1</div>
                        <div class="step-text">กรอกข้อมูล</div>
                    </div>
                    <div id="step2" class="step">
                        <div class="step-number">2</div>
                        <div class="step-text">สแกน QR Code</div>
                    </div>
                    <div id="step3" class="step">
                        <div class="step-number">3</div>
                        <div class="step-text">อัพโหลดสลิป</div>
                    </div>
                    <div id="step4" class="step">
                        <div class="step-number">4</div>
                        <div class="step-text">ยืนยันการเติมเงิน</div>
                    </div>
                </div>
            </div>

            <!-- Current Balance -->
            <div class="bg-white rounded-lg shadow p-4 mb-6 card-hover">
                <div class="text-center">
                    <p class="text-gray-500 text-sm mb-1">ยอดเงินปัจจุบัน</p>
                    <p id="currentBalance" class="text-2xl font-bold text-blue-600">฿0.00</p>
                </div>
            </div>

            <!-- QR Code Timer Section -->
            <div id="qrTimerSection" class="bg-white rounded-lg shadow p-6 mb-6 card-hover hidden">
                <div class="text-center">
                    <div class="mb-4">
                        <i class="fas fa-clock text-3xl text-orange-500 mb-2"></i>
                        <p class="text-gray-600 text-sm mb-2">เวลาที่เหลือ</p>
                        <div id="timerDisplay" class="text-4xl font-bold text-orange-600 mb-2">01:00</div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="timerProgress" class="bg-orange-500 h-2 rounded-full transition-all duration-1000" style="width: 100%"></div>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500">กรุณาทำรายการให้เสร็จสิ้นภายในเวลาที่กำหนด</p>
                </div>
            </div>

            <!-- QR Code Section -->
            <div id="qrSection" class="bg-white rounded-lg shadow p-6 mb-6 card-hover hidden">
                <div class="text-center">
                    <h3 class="text-lg font-bold mb-4 text-gray-800">
                        <i class="fas fa-qrcode mr-2 text-blue-500"></i>สแกน QR Code เพื่อโอนเงิน
                    </h3>
                    
                    <!-- QR Code Display -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <canvas id="qrcode" class="mx-auto mb-4"></canvas>
                        <div class="text-sm text-gray-600 space-y-1">
                            <p><strong>ธนาคาร:</strong> <span id="qrBankName"></span></p>
                            <p><strong>เลขที่บัญชี:</strong> <span id="qrAccountNumber"></span></p>
                            <p><strong>จำนวนเงิน:</strong> <span id="qrAmount" class="text-lg font-bold text-blue-600"></span></p>
                        </div>
                    </div>

                    <!-- QR Instructions -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                        <h4 class="font-semibold text-blue-800 mb-2">
                            <i class="fas fa-info-circle mr-1"></i>วิธีการโอนเงิน
                        </h4>
                        <ol class="text-sm text-blue-700 space-y-1 text-left">
                            <li>1. เปิดแอปธนาคารของคุณ</li>
                            <li>2. เลือกโอนเงินผ่าน QR Code</li>
                            <li>3. สแกน QR Code ด้านบน</li>
                            <li>4. ตรวจสอบข้อมูลและยืนยันการโอน</li>
                            <li>5. กลับมาอัพโหลดสลิปที่นี่</li>
                        </ol>
                    </div>

                    <!-- Refresh QR Button -->
                    <button onclick="refreshQR()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition btn-animate mb-4">
                        <i class="fas fa-sync-alt mr-2"></i>สร้าง QR Code ใหม่
                    </button>
                </div>
            </div>

            <!-- Top-up Form -->
            <div class="bg-white rounded-lg shadow p-6 card-hover">
                <h2 class="text-xl font-bold mb-6 text-center">
                    <i class="fas fa-plus-circle mr-2 text-blue-500"></i>เติมเงินเข้ากระเป๋า
                </h2>
                
                <div class="space-y-4">
                    <!-- Amount -->
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <i class="fas fa-money-bill-wave mr-1"></i>จำนวนเงิน (บาท)
                        </label>
                        <input type="number" id="topupAmount" step="0.01" min="100" placeholder="ขั้นต่ำ 100 บาท"
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">จำนวนเงินขั้นต่ำ 100 บาท</p>
                    </div>

                    <!-- Bank Selection -->
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <i class="fas fa-university mr-1"></i>ธนาคาร
                        </label>
                        <select id="topupBank" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="updateAccountNumber()">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>

                    <!-- Account Number -->
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <i class="fas fa-credit-card mr-1"></i>เลขที่บัญชี
                        </label>
                        <div class="relative">
                            <input type="text" id="topupAccountNumber" placeholder="เลขที่บัญชีจะแสดงอัตโนมัติ"
                                   class="w-full p-3 border rounded-lg bg-gray-50" readonly>
                            <button onclick="copyAccountNumber()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-blue-600 hover:text-blue-800">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">คลิกที่ไอคอนเพื่อคัดลอกเลขบัญชี</p>
                    </div>

                    <!-- Generate QR Button -->
                    <div id="generateQRSection">
                        <button id="generateQRBtn" onclick="generateQRCode()" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition btn-animate" disabled>
                            <i class="fas fa-qrcode mr-2"></i>สร้าง QR Code สำหรับโอนเงิน
                        </button>
                    </div>

                    <!-- Slip Upload -->
                    <div id="slipUploadSection" class="hidden">
                        <label class="block text-sm font-medium mb-2">
                            <i class="fas fa-upload mr-1"></i>อัพโหลดสลิปโอนเงิน
                        </label>
                        <label id="topupSlipLabel" for="topupSlip" class="block w-full p-4 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition text-center">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">ลากไฟล์มาวางที่นี่หรือคลิกเพื่อเลือกไฟล์</p>
                            <p class="text-xs text-gray-500 mt-1">รองรับ JPG, PNG ขนาดไม่เกิน 5MB</p>
                        </label>
                        <input type="file" id="topupSlip" accept="image/jpeg,image/png" class="hidden">
                        
                        <div id="filePreview" class="mt-3 hidden">
                            <p id="topupFileName" class="text-sm text-gray-600 mb-2"></p>
                            <img id="previewImage" src="" alt="Preview" class="file-preview mt-2 w-full max-h-48 object-cover rounded-lg">
                            <button onclick="removeSlip()" class="mt-2 text-sm text-red-600 hover:text-red-800 btn-animate">
                                <i class="fas fa-trash-alt mr-1"></i>ลบไฟล์
                            </button>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h4 class="font-semibold text-yellow-800 mb-2">
                            <i class="fas fa-info-circle mr-1"></i>วิธีการเติมเงิน
                        </h4>
                        <ol class="text-sm text-yellow-700 space-y-1">
                            <li>1. กรอกจำนวนเงินและเลือกธนาคาร</li>
                            <li>2. กดสร้าง QR Code</li>
                            <li>3. สแกน QR Code ด้วยแอปธนาคาร</li>
                            <li>4. โอนเงินตามจำนวนที่ระบุ</li>
                            <li>5. อัพโหลดสลิปการโอนเงิน</li>
                            <li>6. กดยืนยันการเติมเงิน</li>
                        </ol>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex space-x-3 mt-6">
                    <button id="submitTopupBtn" onclick="submitTopup()" class="flex-1 bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition disabled:opacity-50 disabled:cursor-not-allowed btn-animate hidden">
                        <span id="submitText">ยืนยันการเติมเงิน</span>
                        <span id="submitSpinner" class="spinner"></span>
                    </button>
                    <button onclick="goBack()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition btn-animate">
                        <i class="fas fa-times mr-2"></i>ยกเลิก
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script>
        // Global Variables
        let userData = {};
        let walletData = { balance: 0 };
        let qrTimer = null;
        let qrTimeLeft = 60; // 1 minute in seconds
        let isQRActive = false;

        // Mock bank accounts (replace with your actual bank accounts)
        const BANK_ACCOUNTS = {
            'กสิกรไทย': '1234567890',
            'กรุงเทพ': '0987654321',
            'ไทยพาณิชย์': '1122334455',
            'กรุงไทย': '5566778899'
        };

        // File validation constants
        const ALLOWED_FILE_TYPES = ['image/jpeg', 'image/png'];
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

        // Mock API URL
        const API_URL = 'https://your-api-endpoint.com/api';

        // Go back function
        function goBack() {
            clearQRTimer();
            window.history.back();
        }

        // Update bank dropdowns in the UI
        function updateBankDropdowns() {
            const bankSelect = document.getElementById('topupBank');
            
            if (bankSelect) {
                // Clear existing options
                bankSelect.innerHTML = '<option value="">-- เลือกธนาคาร --</option>';
                
                // Add new options based on BANK_ACCOUNTS
                for (const [bankName, accountNumber] of Object.entries(BANK_ACCOUNTS)) {
                    const option = document.createElement('option');
                    option.value = bankName;
                    option.textContent = bankName;
                    bankSelect.appendChild(option);
                }
            }
        }

        // Update account number based on bank selection
        function updateAccountNumber() {
            const bankSelect = document.getElementById('topupBank');
            const accountNumberField = document.getElementById('topupAccountNumber');
            const generateQRBtn = document.getElementById('generateQRBtn');
            
            if (bankSelect && accountNumberField) {
                const selectedBank = bankSelect.value;
                accountNumberField.value = BANK_ACCOUNTS[selectedBank] || '';
                
                // Enable/disable QR generation button
                const amount = parseFloat(document.getElementById('topupAmount').value) || 0;
                generateQRBtn.disabled = !selectedBank || amount < 100;
                
                updateProcessSteps(selectedBank ? 1 : 1);
            }
        }

        // Copy account number to clipboard
        function copyAccountNumber() {
            const accountNumber = document.getElementById('topupAccountNumber').value;
            if (accountNumber) {
                navigator.clipboard.writeText(accountNumber).then(() => {
                    // Show feedback
                    const copyBtn = event.target.closest('button');
                    const originalIcon = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check text-green-600"></i>';
                    setTimeout(() => {
                        copyBtn.innerHTML = originalIcon;
                    }, 2000);
                    
                    // Show toast notification
                    Swal.fire({
                        icon: 'success',
                        title: 'คัดลอกเรียบร้อย',
                        text: 'เลขที่บัญชีถูกคัดลอกแล้ว',
                        timer: 1500,
                        showConfirmButton: false,
                        toast: true,
                        position: 'top-end'
                    });
                }).catch(() => {
                    Swal.fire('ข้อผิดพลาด', 'ไม่สามารถคัดลอกได้', 'error');
                });
            }
        }

        // Generate QR Code
        function generateQRCode() {
            const amount = parseFloat(document.getElementById('topupAmount').value);
            const bank = document.getElementById('topupBank').value;
            const account = document.getElementById('topupAccountNumber').value;

            if (!amount || amount < 100) {
                Swal.fire('ผิดพลาด', 'กรุณากรอกจำนวนเงินที่ต้องการเติม (ขั้นต่ำ 100 บาท)', 'error');
                return;
            }
            if (!bank) {
                Swal.fire('ผิดพลาด', 'กรุณาเลือกธนาคาร', 'error');
                return;
            }

            // Clear any existing timer
            clearQRTimer();

            // Generate QR Code data (PromptPay format)
            const qrData = generatePromptPayQR(account, amount);

            // Display QR Code
            const canvas = document.getElementById('qrcode');
            QrCode.toCanvas(canvas, qrData, { width: 200, margin: 2 }, function (error) {
                if (error) {
                    console.error('Error generating QR Code:', error);
                    Swal.fire('ผิดพลาด', 'ไม่สามารถสร้าง QR Code ได้', 'error');
                    return;
                }

                // Update QR display information
                document.getElementById('qrBankName').textContent = bank;
                document.getElementById('qrAccountNumber').textContent = account;
                document.getElementById('qrAmount').textContent = '฿' + formatCurrency(amount);

                // Show QR sections
                document.getElementById('qrSection').classList.remove('hidden');
                document.getElementById('qrTimerSection').classList.remove('hidden');
                document.getElementById('slipUploadSection').classList.remove('hidden');
                document.getElementById('submitTopupBtn').classList.remove('hidden');
                document.getElementById('generateQRSection').classList.add('hidden');

                // Update process steps
                updateProcessSteps(2);

                // Start timer
                startQRTimer();

                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'สร้าง QR Code สำเร็จ!',
                    text: 'กรุณาสแกน QR Code ด้วยแอปธนาคารของคุณ',
                    timer: 2000,
                    showConfirmButton: false
                });
            });
        }

        // Generate PromptPay QR Code data
        function generatePromptPayQR(accountNumber, amount) {
            // This is a simplified version - in real implementation, you'd need proper PromptPay format
            const qrData = `promptpay://transfer?account=${accountNumber}&amount=${amount}`;
            return qrData;
        }

        // Start QR Timer
        function startQRTimer() {
            isQRActive = true;
            qrTimeLeft = 60; // Reset to 1 minute
            
            qrTimer = setInterval(() => {
                qrTimeLeft--;
                updateTimerDisplay();
                
                if (qrTimeLeft <= 0) {
                    clearQRTimer();
                    handleQRTimeout();
                }
            }, 1000);
        }

        // Clear QR Timer
        function clearQRTimer() {
            if (qrTimer) {
                clearInterval(qrTimer);
                qrTimer = null;
            }
            isQRActive = false;
        }

        // Update Timer Display
        function updateTimerDisplay() {
            const minutes = Math.floor(qrTimeLeft / 60);
            const seconds = qrTimeLeft % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('timerDisplay').textContent = timeString;
            
            // Update progress bar
            const progressPercent = (qrTimeLeft / 60) * 100;
            document.getElementById('timerProgress').style.width = `${progressPercent}%`;
            
            // Change color based on time left
            const timerDisplay = document.getElementById('timerDisplay');
            const progressBar = document.getElementById('timerProgress');
            
            if (qrTimeLeft <= 15) {
                timerDisplay.className = 'text-4xl font-bold text-red-600 mb-2';
                progressBar.className = 'bg-red-500 h-2 rounded-full transition-all duration-1000';
            } else if (qrTimeLeft <= 30) {
                timerDisplay.className = 'text-4xl font-bold text-orange-600 mb-2';
                progressBar.className = 'bg-orange-500 h-2 rounded-full transition-all duration-1000';
            }
        }

        // Handle QR Timeout
        function handleQRTimeout() {
            Swal.fire({
                icon: 'warning',
                title: 'หมดเวลา!',
                text: 'QR Code หมดอายุแล้ว กำลังกลับสู่หน้าหลัก...',
                timer: 3000,
                showConfirmButton: false,
                allowOutsideClick: false
            }).then(() => {
                window.location.href = 'index.html';
            });
        }

        // Refresh QR Code
        function refreshQR() {
            clearQRTimer();
            generateQRCode();
        }

        // Function to update process steps
        function updateProcessSteps(step) {
            // Reset all steps
            document.querySelectorAll('.step').forEach(el => {
                el.classList.remove('active', 'completed');
            });

            // Mark completed steps
            for (let i = 1; i < step; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
            }

            // Mark current step
            if (step <= 4) {
                document.getElementById(`step${step}`).classList.add('active');
            }
        }

        // Function to remove slip
        function removeSlip() {
            document.getElementById('topupSlip').value = '';
            document.getElementById('filePreview').classList.add('hidden');
            document.getElementById('previewImage').src = '';
            document.getElementById('topupFileName').textContent = '';
            updateProcessSteps(3);
        }

        // Submit top-up request
        async function submitTopup() {
            const amount = parseFloat(document.getElementById('topupAmount').value);
            const bank = document.getElementById('topupBank').value;
            const account = document.getElementById('topupAccountNumber').value;
            const slipFile = document.getElementById('topupSlip').files[0];

            // Validate inputs
            if (!amount || amount < 100) {
                Swal.fire('ผิดพลาด', 'กรุณากรอกจำนวนเงินที่ต้องการเติม (ขั้นต่ำ 100 บาท)', 'error');
                return;
            }
            if (!bank) {
                Swal.fire('ผิดพลาด', 'กรุณาเลือกธนาคาร', 'error');
                return;
            }
            if (!slipFile) {
                Swal.fire('ผิดพลาด', 'กรุณาอัพโหลดสลิปโอนเงิน', 'error');
                return;
            }

            // Clear timer since transaction is being submitted
            clearQRTimer();

            // Show loading
            Swal.fire({
                title: 'กำลังบันทึก...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // Use FileReader like in the example
                let fr = new FileReader();
                fr.addEventListener('loadend', () => {
                    let res = fr.result;
                    let spt = res.split("base64,")[1];
                    
                    // Prepare payload using the same structure as example
                    let obj = {
                        action: 'topup',
                        userId: userData.userId,
                        amount: amount,
                        bank: bank,
                        account: account,
                        base64: spt,
                        type: slipFile.type,
                        name: slipFile.name
                    };

                    // Send data using the same method as example (without Content-Type header)
                    fetch(API_URL, {
                        method: "POST",
                        body: JSON.stringify(obj)
                    })
                    .then(r => r.text())
                    .then(data => {
                        console.log('Response:', data);
                        
                        // ปิด Loading และแสดงข้อความสำเร็จ
                        Swal.fire({
                            icon: 'success',
                            title: '🎉 เติมเงินสำเร็จ!',
                            html: `
                                <div class="text-center space-y-3">
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <p class="text-lg font-semibold text-green-800">รายละเอียดการเติมเงิน</p>
                                        <hr class="my-2">
                                        <div class="text-left space-y-1">
                                            <p><strong>จำนวนเงิน:</strong> ฿${formatCurrency(amount)}</p>
                                            <p><strong>ธนาคาร:</strong> ${bank}</p>
                                            <p><strong>เลขที่บัญชี:</strong> ${account}</p>
                                        </div>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <p class="text-sm text-blue-800">💰 เงินจะเข้าบัญชีภายใน 5-10 นาที</p>
                                        <p class="text-sm text-blue-800">📱 คุณจะได้รับการแจ้งเตือนผ่าน LINE</p>
                                    </div>
                                </div>
                            `,
                            confirmButtonText: 'กลับหน้าหลัก',
                            confirmButtonColor: '#10b981',
                            allowOutsideClick: false
                        }).then(() => {
                            window.location.href = 'index.html';
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถบันทึกข้อมูลได้: ' + error.message
                        });
                    });
                });

                if (slipFile) {
                    fr.readAsDataURL(slipFile);
                }

            } catch (error) {
                console.error('Error:', error);
                Swal.fire('ผิดพลาด', error.message || 'เกิดข้อผิดพลาดในการเติมเงิน', 'error');
            }
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Load Wallet Data
        async function loadWalletData() {
            try {
                const response = await fetch(`${API_URL}?action=getWallet&userId=${userData.userId}`);
                const data = await response.json();
                if (data.success) {
                    walletData.balance = data.balance || 0;
                    document.getElementById('currentBalance').textContent = '฿' + formatCurrency(walletData.balance);
                }
            } catch (error) {
                console.error('Error loading wallet data:', error);
            }
        }

        // Initialize LIFF
        window.onload = async function() {
            try {
                // Mock LIFF initialization for demo
                // await liff.init({ liffId: LIFF_ID });
                // if (liff.isLoggedIn()) {
                    initApp();
                // } else {
                //     liff.login();
                // }
            } catch (err) {
                console.error('LIFF init failed:', err);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถเริ่มต้น LIFF ได้', 'error');
            }
        };

        // Initialize App
        async function initApp() {
            try {
                // Mock user data for demo
                userData = {
                    userId: 'demo_user_123',
                    name: 'Demo User',
                    picture: 'https://via.placeholder.com/150'
                };

                await loadWalletData();
                updateBankDropdowns();
                updateProcessSteps(1);

                // Set up file input
                const fileInput = document.getElementById('topupSlip');
                const fileLabel = document.getElementById('topupSlipLabel');
                const filePreview = document.getElementById('filePreview');
                const fileName = document.getElementById('topupFileName');
                const previewImage = document.getElementById('previewImage');

                // Real-time amount validation
                document.getElementById('topupAmount').addEventListener('input', function() {
                    const amount = parseFloat(this.value) || 0;
                    const generateQRBtn = document.getElementById('generateQRBtn');
                    const bank = document.getElementById('topupBank').value;

                    if (amount < 100 || !bank) {
                        generateQRBtn.disabled = true;
                        this.style.borderColor = amount < 100 ? '#ef4444' : '#d1d5db';
                    } else {
                        generateQRBtn.disabled = false;
                        this.style.borderColor = '#10b981';
                    }
                });

                // Bank selection validation
                document.getElementById('topupBank').addEventListener('change', function() {
                    const amount = parseFloat(document.getElementById('topupAmount').value) || 0;
                    const generateQRBtn = document.getElementById('generateQRBtn');

                    generateQRBtn.disabled = amount < 100 || !this.value;
                });

                // File input change handler
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];

                        // Validate file type
                        if (!ALLOWED_FILE_TYPES.includes(file.type)) {
                            Swal.fire({
                                icon: 'error',
                                title: 'ประเภทไฟล์ไม่ถูกต้อง',
                                text: 'ไฟล์ต้องเป็นรูปภาพ JPG หรือ PNG เท่านั้น',
                                confirmButtonColor: '#3b82f6'
                            });
                            fileInput.value = '';
                            return;
                        }

                        // Validate file size
                        if (file.size > MAX_FILE_SIZE) {
                            Swal.fire({
                                icon: 'error',
                                title: 'ไฟล์มีขนาดใหญ่เกินไป',
                                text: 'ขนาดไฟล์ต้องไม่เกิน 5MB',
                                confirmButtonColor: '#3b82f6'
                            });
                            fileInput.value = '';
                            return;
                        }

                        // Show file preview
                        fileName.textContent = file.name;
                        filePreview.classList.remove('hidden');
                        updateProcessSteps(4);

                        // Show preview image
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            previewImage.src = event.target.result;
                        };
                        reader.readAsDataURL(file);

                        // Reset timer when user uploads slip (user activity detected)
                        if (isQRActive) {
                            clearQRTimer();
                            startQRTimer();
                        }
                    }
                });

                // Drag and drop functionality
                fileLabel.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    fileLabel.classList.add('border-blue-500', 'bg-blue-50');
                    fileLabel.querySelector('p').textContent = 'ปล่อยไฟล์ที่นี่เพื่ออัพโหลด';
                });

                fileLabel.addEventListener('dragleave', function() {
                    fileLabel.classList.remove('border-blue-500', 'bg-blue-50');
                    fileLabel.querySelector('p').textContent = 'ลากไฟล์มาวางที่นี่หรือคลิกเพื่อเลือกไฟล์';
                });

                fileLabel.addEventListener('drop', function(e) {
                    e.preventDefault();
                    fileLabel.classList.remove('border-blue-500', 'bg-blue-50');
                    fileLabel.querySelector('p').textContent = 'ลากไฟล์มาวางที่นี่หรือคลิกเพื่อเลือกไฟล์';

                    if (e.dataTransfer.files.length > 0) {
                        const file = e.dataTransfer.files[0];

                        // Validate file type
                        if (!ALLOWED_FILE_TYPES.includes(file.type)) {
                            Swal.fire({
                                icon: 'error',
                                title: 'ประเภทไฟล์ไม่ถูกต้อง',
                                text: 'ไฟล์ต้องเป็นรูปภาพ JPG หรือ PNG เท่านั้น',
                                confirmButtonColor: '#3b82f6'
                            });
                            return;
                        }

                        // Validate file size
                        if (file.size > MAX_FILE_SIZE) {
                            Swal.fire({
                                icon: 'error',
                                title: 'ไฟล์มีขนาดใหญ่เกินไป',
                                text: 'ขนาดไฟล์ต้องไม่เกิน 5MB',
                                confirmButtonColor: '#3b82f6'
                            });
                            return;
                        }

                        // Set file to input
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;

                        // Trigger change event
                        const event = new Event('change');
                        fileInput.dispatchEvent(event);
                    }
                });

                // Listen for user activity to reset timer
                document.addEventListener('click', function() {
                    if (isQRActive) {
                        // User clicked something, reset timer
                        clearQRTimer();
                        startQRTimer();
                    }
                });

                document.addEventListener('keydown', function() {
                    if (isQRActive) {
                        // User typed something, reset timer
                        clearQRTimer();
                        startQRTimer();
                    }
                });

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            } catch (error) {
                console.error('Error initializing app:', error);
                Swal.fire('ข้อผิดพลาด', 'ไม่สามารถเริ่มต้นแอปได้', 'error');
            }
        }

        // Add custom CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            .step {
                display: flex;
                align-items: center;
                margin-bottom: 1rem;
                transition: all 0.3s ease;
            }

            .step-number {
                width: 2rem;
                height: 2rem;
                border-radius: 50%;
                background-color: #e5e7eb;
                color: #6b7280;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                margin-right: 0.75rem;
                transition: all 0.3s ease;
            }

            .step-text {
                font-weight: 500;
                color: #6b7280;
                transition: all 0.3s ease;
            }

            .step.active .step-number {
                background-color: #3b82f6;
                color: white;
            }

            .step.active .step-text {
                color: #3b82f6;
            }

            .step.completed .step-number {
                background-color: #10b981;
                color: white;
            }

            .step.completed .step-text {
                color: #10b981;
            }

            .btn-animate {
                transition: all 0.2s ease;
                transform: translateY(0);
            }

            .btn-animate:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .btn-animate:active {
                transform: translateY(0);
            }

            .card-hover {
                transition: all 0.3s ease;
            }

            .card-hover:hover {
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                transform: translateY(-2px);
            }

            .spinner {
                display: none;
                width: 1rem;
                height: 1rem;
                border: 2px solid #ffffff;
                border-top: 2px solid transparent;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-left: 0.5rem;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .file-preview {
                border: 2px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 0.5rem;
            }

            @media (max-width: 768px) {
                .mobile-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                }

                .page-title {
                    font-size: 1.25rem;
                    font-weight: 600;
                    flex: 1;
                    text-align: center;
                }

                .back-btn {
                    width: 2.5rem;
                    height: 2.5rem;
                    background-color: rgba(255, 255, 255, 0.2);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    border: none;
                    cursor: pointer;
                    transition: all 0.2s ease;
                }

                .back-btn:hover {
                    background-color: rgba(255, 255, 255, 0.3);
                    transform: scale(1.05);
                }

                .page-container {
                    padding-top: 1rem;
                    min-height: calc(100vh - 80px);
                }
            }

            .process-steps {
                display: flex;
                flex-direction: column;
            }

            @media (min-width: 640px) {
                .process-steps {
                    flex-direction: row;
                    justify-content: space-between;
                }

                .step {
                    flex: 1;
                    margin-bottom: 0;
                    margin-right: 1rem;
                }

                .step:last-child {
                    margin-right: 0;
                }

                .step-text {
                    font-size: 0.875rem;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

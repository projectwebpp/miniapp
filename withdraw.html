<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ถอนเงินจากกระเป๋าเงิน</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 600px;
            margin-top: 50px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            border: none;
        }
        .card-header {
            background-color: #d4af37;
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: bold;
            text-align: center;
            padding: 15px;
        }
        .form-label {
            font-weight: 500;
        }
        .btn-gold {
            background-color: #d4af37;
            border-color: #d4af37;
            color: white;
            font-weight: bold;
        }
        .btn-gold:hover {
            background-color: #c9a227;
            border-color: #c9a227;
            color: white;
        }
        .balance-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #28a745;
            text-align: center;
            margin-bottom: 20px;
        }
        .bank-logo {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        .bank-option {
            display: flex;
            align-items: center;
        }
        .required-field::after {
            content: " *";
            color: red;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h4>ถอนเงินจากกระเป๋าเงิน</h4>
            </div>
            <div class="card-body">
                <div id="balanceDisplay" class="balance-display">
                    กำลังโหลดยอดเงิน...
                </div>
                
                <form id="withdrawForm">
                    <div class="mb-3">
                        <label for="amount" class="form-label required-field">จำนวนเงินที่ต้องการถอน (บาท)</label>
                        <input type="number" class="form-control" id="amount" min="100" step="1" required>
                        <div class="form-text">จำนวนเงินขั้นต่ำ 100 บาท</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bank" class="form-label required-field">ธนาคาร</label>
                        <select class="form-select" id="bank" required>
                            <option value="" selected disabled>เลือกธนาคาร</option>
                            <!-- จะเติมข้อมูลธนาคารด้วย JavaScript -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="accountNumber" class="form-label required-field">เลขที่บัญชี</label>
                        <input type="text" class="form-control" id="accountNumber" minlength="10" maxlength="15" pattern="\d*" required>
                        <div class="form-text">เลขที่บัญชีต้องเป็นตัวเลข 10-15 หลัก</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="accountName" class="form-label required-field">ชื่อบัญชี</label>
                        <input type="text" class="form-control" id="accountName" required>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-gold btn-lg" id="submitBtn">
                            ส่งคำขอถอนเงิน
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modal แจ้งเตือน -->
        <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">ผลการดำเนินการ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modalBody">
                        <!-- ข้อความผลลัพธ์จะแสดงที่นี่ -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ตัวแปร global
        let currentBalance = 0;
        let bankAccounts = [];
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        
        // เมื่อหน้าเว็บโหลดเสร็จ
        document.addEventListener('DOMContentLoaded', async function() {
            // ดึงข้อมูลผู้ใช้ (ในระบบจริงควรได้จากระบบล็อกอิน)
            const userId = getUserId(); // ฟังก์ชันนี้ควรดึง ID ผู้ใช้จากระบบล็อกอิน
            
            // โหลดข้อมูลยอดเงินและบัญชีธนาคาร
            await Promise.all([
                loadBalance(userId),
                loadBankAccounts()
            ]);
            
            // ตั้งค่าการส่งฟอร์ม
            document.getElementById('withdrawForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await submitWithdrawal(userId);
            });
        });
        
        // ฟังก์ชันดึง ID ผู้ใช้ (ตัวอย่าง)
        function getUserId() {
            // ในระบบจริงควรดึงจากระบบล็อกอิน
            // ตัวอย่างนี้ใช้การรับจาก URL หรือ localStorage
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('userId') || localStorage.getItem('userId') || 'user123';
        }
        
        // โหลดยอดเงินจากเซิร์ฟเวอร์
        async function loadBalance(userId) {
            try {
                const response = await fetch(`https://script.google.com/macros/s/AKfycbwS4EwiW66bx8AKD7bt40vcFbZK7xpCod46EeomxBGGfFF_2YARo0xASMSmbPBVnKY0/execc?action=getWallet&userId=${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentBalance = data.balance;
                    document.getElementById('balanceDisplay').textContent = `ยอดเงินคงเหลือ: ${currentBalance.toLocaleString()} บาท`;
                } else {
                    showError('ไม่สามารถโหลดยอดเงินได้: ' + data.message);
                }
            } catch (error) {
                showError('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message);
            }
        }
        
        // โหลดข้อมูลบัญชีธนาคาร
        async function loadBankAccounts() {
            try {
                const response = await fetch(`https://script.google.com/macros/s/AKfycbwS4EwiW66bx8AKD7bt40vcFbZK7xpCod46EeomxBGGfFF_2YARo0xASMSmbPBVnKY0/exec?action=getBankAccounts`);
                const data = await response.json();
                
                if (data.success) {
                    bankAccounts = data.bankAccounts;
                    const bankSelect = document.getElementById('bank');
                    
                    // ล้าง options เดิม
                    bankSelect.innerHTML = '<option value="" selected disabled>เลือกธนาคาร</option>';
                    
                    // เพิ่ม options ใหม่
                    bankAccounts.forEach(bank => {
                        const option = document.createElement('option');
                        option.value = bank.bankName;
                        option.textContent = bank.bankName;
                        bankSelect.appendChild(option);
                    });
                } else {
                    showError('ไม่สามารถโหลดข้อมูลธนาคารได้: ' + data.message);
                }
            } catch (error) {
                showError('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message);
            }
        }
        
        // ส่งคำขอถอนเงิน
        async function submitWithdrawal(userId) {
            const amount = parseFloat(document.getElementById('amount').value);
            const bank = document.getElementById('bank').value;
            const accountNumber = document.getElementById('accountNumber').value;
            const accountName = document.getElementById('accountName').value;
            
            // ตรวจสอบข้อมูลเบื้องต้น
            if (amount < 100) {
                showError('จำนวนเงินต้องไม่ต่ำกว่า 100 บาท');
                return;
            }
            
            if (amount > currentBalance) {
                showError('ยอดเงินในกระเป๋าไม่เพียงพอ');
                return;
            }
            
            if (!bank || !accountNumber || !accountName) {
                showError('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }
            
            if (accountNumber.length < 10 || accountNumber.length > 15 || !/^\d+$/.test(accountNumber)) {
                showError('เลขที่บัญชีต้องเป็นตัวเลข 10-15 หลัก');
                return;
            }
            
            // ปุ่ม submit
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังดำเนินการ...';
            
            try {
                const response = await fetch(`https://script.google.com/macros/s/AKfycbwS4EwiW66bx8AKD7bt40vcFbZK7xpCod46EeomxBGGfFF_2YARo0xASMSmbPBVnKY0/exec`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'withdraw',
                        userId: userId,
                        amount: amount,
                        bank: bank,
                        account: accountNumber,
                        accountName: accountName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    // รีเซ็ตฟอร์ม
                    document.getElementById('withdrawForm').reset();
                    // โหลดยอดเงินใหม่
                    await loadBalance(userId);
                } else {
                    showError(data.message || 'เกิดข้อผิดพลาดในการถอนเงิน');
                }
            } catch (error) {
                showError('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ส่งคำขอถอนเงิน';
            }
        }
        
        // แสดงผลสำเร็จ
        function showSuccess(message) {
            document.getElementById('modalTitle').textContent = 'สำเร็จ';
            document.getElementById('modalTitle').className = 'modal-title text-success';
            document.getElementById('modalBody').textContent = message;
            resultModal.show();
        }
        
        // แสดงข้อผิดพลาด
        function showError(message) {
            document.getElementById('modalTitle').textContent = 'เกิดข้อผิดพลาด';
            document.getElementById('modalTitle').className = 'modal-title text-danger';
            document.getElementById('modalBody').textContent = message;
            resultModal.show();
        }
    </script>
</body>
</html>

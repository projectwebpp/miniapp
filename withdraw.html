<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô - ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡∏°‡∏ó‡∏≠‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Prompt', sans-serif;
        }
        .valid-input {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        .invalid-input {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        .warning-input {
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }
        .btn-animate {
            transition: all 0.3s ease;
        }
        .btn-animate:hover {
            transform: translateY(-2px);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .mobile-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);
        }
        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            flex: 1;
            text-align: center;
        }
        .back-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Mobile Header -->
    <div class="mobile-header p-4 flex items-center space-x-4">
        <button onclick="goBack()" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="page-title">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h1>
        <div class="w-10"></div>
    </div>

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <i class="fas fa-hand-holding-usd text-6xl text-orange-500 animate-pulse mb-4"></i>
            <p class="text-gray-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            <div class="w-8 h-8 border-4 border-orange-200 border-t-orange-500 rounded-full animate-spin mx-auto mt-4"></div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="hidden page-container p-4 fade-in">
        <div class="max-w-md mx-auto">
            <!-- Current Balance -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 card-hover">
                <div class="text-center">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                        <i class="fas fa-wallet text-2xl text-green-600"></i>
                    </div>
                    <p class="text-gray-500 text-sm mb-1">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                    <p id="withdrawBalance" class="text-3xl font-bold text-green-600 mb-2">‡∏ø0.00</p>
                    <p class="text-xs text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ</p>
                </div>
            </div>

            <!-- Withdraw Form -->
            <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                <h2 class="text-xl font-bold mb-6 text-center text-gray-800">
                    <i class="fas fa-money-check-alt mr-2 text-orange-500"></i>‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤
                </h2>
                
                <div class="space-y-6">
                    <!-- Quick Amount Buttons -->
                    <div>
                        <label class="block text-sm font-medium mb-3 text-gray-700">
                            <i class="fas fa-bolt mr-1 text-orange-500"></i>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡πà‡∏ß‡∏ô
                        </label>
                        <div class="grid grid-cols-3 gap-2" id="quickAmountButtons">
                            <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                        </div>
                    </div>

                    <!-- Amount Input -->
                    <div class="input-group">
                        <label class="block text-sm font-medium mb-2 text-gray-700">
                            <i class="fas fa-money-bill-wave mr-1 text-orange-500"></i>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)
                        </label>
                        <input type="number" id="withdrawAmount" step="0.01" min="100" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó"
                               class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg font-medium">
                        <div id="amountError" class="text-xs text-red-500 mt-1 hidden"></div>
                        <p class="text-xs text-gray-500 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó</p>
                    </div>

                    <!-- Bank Selection -->
                    <div class="input-group">
                        <label class="block text-sm font-medium mb-2 text-gray-700">
                            <i class="fas fa-university mr-1 text-orange-500"></i>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
                        </label>
                        <select id="withdrawBank" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ --</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (BBL)</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (KTB)</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï (TTB)</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ (BAY)</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ô‡∏≤‡∏Ñ‡∏¥‡∏ô‡∏†‡∏±‡∏ó‡∏£">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ô‡∏≤‡∏Ñ‡∏¥‡∏ô‡∏†‡∏±‡∏ó‡∏£ (KKP)</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ã‡∏µ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏°‡∏ö‡∏µ ‡πÑ‡∏ó‡∏¢">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ã‡∏µ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏°‡∏ö‡∏µ ‡πÑ‡∏ó‡∏¢ (CIMB)</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏¢‡∏π‡πÇ‡∏≠‡∏ö‡∏µ">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏¢‡∏π‡πÇ‡∏≠‡∏ö‡∏µ (UOB)</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏ô‡∏î‡πå ‡πÅ‡∏≠‡∏ô‡∏î‡πå ‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏ô‡∏î‡πå ‡πÅ‡∏≠‡∏ô‡∏î‡πå ‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå (LHFG)</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô (GSB)</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (GHB)</option>
                            <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£ (BAAC)</option>
                        </select>
                        <div id="bankError" class="text-xs text-red-500 mt-1 hidden"></div>
                    </div>

                    <!-- Account Number -->
                    <div class="input-group">
                        <label class="block text-sm font-medium mb-2 text-gray-700">
                            <i class="fas fa-credit-card mr-1 text-orange-500"></i>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                        </label>
                        <input type="text" id="withdrawAccount" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ 10-15 ‡∏´‡∏•‡∏±‡∏Å"
                               class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg font-mono" 
                               pattern="[0-9]{10,15}" maxlength="15">
                        <div id="accountError" class="text-xs text-red-500 mt-1 hidden"></div>
                        <p class="text-xs text-gray-500 mt-1">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏µ‡∏î)</p>
                    </div>

                    <!-- Account Name -->
                    <div class="input-group">
                        <label class="block text-sm font-medium mb-2 text-gray-700">
                            <i class="fas fa-user mr-1 text-orange-500"></i>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                        </label>
                        <input type="text" id="withdrawAccountName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"
                               class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg">
                        <div id="nameError" class="text-xs text-red-500 mt-1 hidden"></div>
                        <p class="text-xs text-gray-500 mt-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</p>
                    </div>

                    <!-- Processing Fee Info -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
                        <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                            <i class="fas fa-info-circle mr-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                        </h4>
                        <div class="grid grid-cols-2 gap-4 text-sm text-blue-700">
                            <div class="flex items-center">
                                <i class="fas fa-clock mr-2 text-blue-500"></i>
                                <span>1-2 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-gift mr-2 text-blue-500"></i>
                                <span>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°: ‡∏ü‡∏£‡∏µ</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-coins mr-2 text-blue-500"></i>
                                <span>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: 100 ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-business-time mr-2 text-blue-500"></i>
                                <span>‡∏à.-‡∏®. 9:00-17:00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Terms and Conditions -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="flex items-start space-x-3 cursor-pointer">
                            <input type="checkbox" id="acceptTerms" class="mt-1 rounded border-gray-300 text-orange-600 focus:ring-orange-500 w-4 h-4">
                            <span class="text-sm text-gray-700 leading-relaxed">
                                ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö
                                <a href="#" onclick="showTerms()" class="text-orange-600 hover:text-orange-800 underline font-medium">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</a>
                                ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </span>
                        </label>
                        <div id="termsError" class="text-xs text-red-500 mt-2 hidden"></div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex space-x-3 mt-8">
                    <button id="submitWithdrawBtn" onclick="submitWithdraw()" 
                            class="flex-1 bg-gray-400 text-white py-4 rounded-xl font-semibold transition-all duration-300 disabled:cursor-not-allowed btn-animate text-lg"
                            disabled>
                        <i class="fas fa-paper-plane mr-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                    </button>
                    <button onclick="goBack()" class="px-6 bg-gray-300 text-gray-700 py-4 rounded-xl font-semibold hover:bg-gray-400 transition-all duration-300 btn-animate">
                        <i class="fas fa-times mr-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>
    </div>
    
      <script src="config.js"></script>
    <script src="utils.js"></script>
    <script>
        // Global Variables
        let userData = {};
        let currentGoldData = { totalGold: 0, avgPrice: 0, balances: { bar: { totalGold: 0, avgPrice: 0 }, ornament: { totalGold: 0, avgPrice: 0 } } };
        let walletData = { balance: 0, transactions: [] };

        // Go back function
        function goBack() {
            window.history.back();
        }

        // Add processing state management
        function setProcessing(state) {
            isProcessing = state;
            const submitBtn = document.getElementById('submitWithdrawBtn');
            
            if (state) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';
                submitBtn.className = 'flex-1 bg-gray-400 text-white py-4 rounded-xl font-semibold cursor-not-allowed text-lg';
            } else {
                updateButtonState(); // Reset to normal state
            }
        }

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatAccountNumber(accountNumber) {
            if (!accountNumber) return '';
            
            const cleaned = accountNumber.replace(/\D/g, '');
            
            if (cleaned.length === 10) {
                return cleaned.replace(/(\d{3})(\d{1})(\d{5})(\d{1})/, '$1-$2-$3-$4');
            } else if (cleaned.length === 12) {
                return cleaned.replace(/(\d{3})(\d{2})(\d{5})(\d{2})/, '$1-$2-$3-$4');
            } else {
                return cleaned.replace(/(\d{4})(?=\d)/g, '$1-');
            }
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        // Enhanced error logging
        function logError(context, error, additionalData = {}) {
            const errorInfo = {
                context: context,
                message: error.message || error.toString(),
                stack: error.stack,
                timestamp: new Date().toISOString(),
                userData: userData,
                retryCount: retryCount,
                ...additionalData
            };
            
            console.error(`[${context}] Error:`, errorInfo);
            
            // Send error to your logging service if available
            // sendErrorLog(errorInfo);
            
            return errorInfo;
        }

        // Add processing state management
        function setProcessing(state) {
            isProcessing = state;
            const submitBtn = document.getElementById('submitWithdrawBtn');
            
            if (state) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';
                submitBtn.className = 'flex-1 bg-gray-400 text-white py-4 rounded-xl font-semibold cursor-not-allowed text-lg';
            } else {
                updateButtonState(); // Reset to normal state
            }
        }

        // Show terms modal
        function showTerms() {
            Swal.fire({
                title: '‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
                html: `
                    <div class="text-left space-y-3 text-sm">
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                            <h4 class="font-semibold text-yellow-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h4>
                            <ul class="space-y-1 text-yellow-700">
                                <li>‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô 100 ‡∏ö‡∏≤‡∏ó</li>
                                <li>‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</li>
                                <li>‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</li>
                            </ul>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                            <h4 class="font-semibold text-blue-800 mb-2">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h4>
                            <ul class="space-y-1 text-blue-700">
                                <li>‚Ä¢ ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</li>
                                <li>‚Ä¢ ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: 1-2 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</li>
                                <li>‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏®‡∏∏‡∏Å‡∏£‡πå 9:00-17:00 ‡∏ô.</li>
                            </ul>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg border border-green-200">
                            <h4 class="font-semibold text-green-800 mb-2">‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h4>
                            <ul class="space-y-1 text-green-700">
                                <li>‚Ä¢ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</li>
                                <li>‚Ä¢ ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ</li>
                                <li>‚Ä¢ ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</li>
                            </ul>
                        </div>
                    </div>
                `,
                confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö',
                confirmButtonColor: '#f59e0b',
                width: '90%'
            });
        }

        // Create quick amount buttons
        function createQuickAmountButtons() {
            const container = document.getElementById('quickAmountButtons');
            container.innerHTML = '';
            
            const amounts = [500, 1000, 2000, 3000, 5000];
            
            amounts.forEach(amount => {
                if (amount <= walletData.balance) {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'px-3 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium hover:bg-orange-200 transition-colors border border-orange-200';
                    button.textContent = `‡∏ø${formatCurrency(amount)}`;
                    button.onclick = () => {
                        document.getElementById('withdrawAmount').value = amount;
                        validateAmount();
                        updateButtonState();
                    };
                    container.appendChild(button);
                }
            });

            if (walletData.balance >= 100) {
                const allButton = document.createElement('button');
                allButton.type = 'button';
                allButton.className = 'px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200 transition-colors border border-blue-200';
                allButton.textContent = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                allButton.onclick = () => {
                    document.getElementById('withdrawAmount').value = walletData.balance;
                    validateAmount();
                    updateButtonState();
                };
                container.appendChild(allButton);
            }
        }

        // Validation Functions
        function validateAmount() {
            const input = document.getElementById('withdrawAmount');
            const error = document.getElementById('amountError');
            const amount = parseFloat(input.value) || 0;

            error.classList.add('hidden');
            input.classList.remove('valid-input', 'invalid-input', 'warning-input');

            if (!amount) {
                return false;
            } else if (amount < 100) {
                input.classList.add('invalid-input');
                error.textContent = '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó';
                error.classList.remove('hidden');
                return false;
            } else if (amount > walletData.balance) {
                input.classList.add('warning-input');
                error.textContent = `‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ø${formatCurrency(walletData.balance)})`;
                error.classList.remove('hidden');
                return false;
            } else {
                input.classList.add('valid-input');
                return true;
            }
        }

        function validateBank() {
            const select = document.getElementById('withdrawBank');
            const error = document.getElementById('bankError');

            error.classList.add('hidden');
            select.classList.remove('valid-input', 'invalid-input');

            if (!select.value) {
                select.classList.add('invalid-input');
                error.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£';
                error.classList.remove('hidden');
                return false;
            } else {
                select.classList.add('valid-input');
                return true;
            }
        }

        function validateAccount() {
            const input = document.getElementById('withdrawAccount');
            const error = document.getElementById('accountError');
            const account = input.value.trim();

            error.classList.add('hidden');
            input.classList.remove('valid-input', 'invalid-input');

            if (!account) {
                input.classList.add('invalid-input');
                error.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
                error.classList.remove('hidden');
                return false;
            } else if (!/^\d+$/.test(account)) {
                input.classList.add('invalid-input');
                error.textContent = '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
                error.classList.remove('hidden');
                return false;
            } else if (account.length < 10 || account.length > 15) {
                input.classList.add('invalid-input');
                error.textContent = '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 10-15 ‡∏´‡∏•‡∏±‡∏Å';
                error.classList.remove('hidden');
                return false;
            } else {
                input.classList.add('valid-input');
                return true;
            }
        }

        function validateAccountName() {
            const input = document.getElementById('withdrawAccountName');
            const error = document.getElementById('nameError');
            const name = input.value.trim();

            error.classList.add('hidden');
            input.classList.remove('valid-input', 'invalid-input');

            if (!name) {
                input.classList.add('invalid-input');
                error.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
                error.classList.remove('hidden');
                return false;
            } else if (name.length < 2) {
                input.classList.add('invalid-input');
                error.textContent = '‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
                error.classList.remove('hidden');
                return false;
            } else {
                input.classList.add('valid-input');
                return true;
            }
        }

        function validateTerms() {
            const checkbox = document.getElementById('acceptTerms');
            const error = document.getElementById('termsError');

            error.classList.add('hidden');

            if (!checkbox.checked) {
                error.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
                error.classList.remove('hidden');
                return false;
            }
            return true;
        }

        function validateForm() {
            const validAmount = validateAmount();
            const validBank = validateBank();
            const validAccount = validateAccount();
            const validName = validateAccountName();
            const validTerms = validateTerms();

            return validAmount && validBank && validAccount && validName && validTerms;
        }

        function updateButtonState() {
            const submitBtn = document.getElementById('submitWithdrawBtn');
            const isValid = validateForm();

            if (walletData.balance < 100) {
                submitBtn.disabled = true;
                submitBtn.className = 'flex-1 bg-gray-400 text-white py-4 rounded-xl font-semibold cursor-not-allowed text-lg';
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠';
            } else if (!isValid) {
                submitBtn.disabled = true;
                submitBtn.className = 'flex-1 bg-gray-400 text-white py-4 rounded-xl font-semibold cursor-not-allowed text-lg';
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
            } else {
                submitBtn.disabled = false;
                submitBtn.className = 'flex-1 bg-orange-500 text-white py-4 rounded-xl font-semibold hover:bg-orange-600 transition-all duration-300 btn-animate text-lg';
                submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô';
            }
        }

        // Enhanced API call with Google Apps Script specific handling
        async function makeAPICall(payload, attempt = 1) {
            try {
                console.log(`API Call attempt ${attempt}:`, payload);
                
                // Method 1: Try standard fetch with proper GAS headers
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(payload)
                    });

                    if (response.ok) {
                        const text = await response.text();
                        console.log('Raw response:', text);
                        
                        try {
                            const data = JSON.parse(text);
                            console.log('Parsed API Response:', data);
                            return data;
                        } catch (parseError) {
                            console.log('Response is not JSON, assuming success:', text);
                            return { success: true, message: 'Request processed', rawResponse: text };
                        }
                    }
                } catch (method1Error) {
                    console.log('Method 1 failed:', method1Error);
                }

                // Method 2: Try with FormData
                try {
                    const formData = new FormData();
                    Object.keys(payload).forEach(key => {
                        formData.append(key, payload[key]);
                    });

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const text = await response.text();
                        console.log('FormData response:', text);
                        
                        try {
                            const data = JSON.parse(text);
                            return data;
                        } catch (parseError) {
                            return { success: true, message: 'Request processed via FormData', rawResponse: text };
                        }
                    }
                } catch (method2Error) {
                    console.log('Method 2 failed:', method2Error);
                }

                // Method 3: no-cors mode (fallback)
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(payload)
                });

                console.log('No-cors request sent successfully');
                return { success: true, message: 'Request sent in no-cors mode' };

            } catch (error) {
                console.error(`API call failed (attempt ${attempt}):`, error);
                
                if (attempt < MAX_RETRIES) {
                    console.log(`Retrying... (${attempt + 1}/${MAX_RETRIES})`);
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    return makeAPICall(payload, attempt + 1);
                }
                
                throw error;
            }
        }

        // Submit withdraw request with improved error handling
        async function submitWithdraw() {
            // Check if already processing
            if (isProcessing) {
                console.log('Already processing, ignoring request');
                return;
            }

            if (!validateForm()) {
                Swal.fire({
                    icon: 'error',
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    confirmButtonColor: '#ef4444'
                });
                return;
            }

            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const bank = document.getElementById('withdrawBank').value;
            const accountNumber = document.getElementById('withdrawAccount').value.trim();
            const accountName = document.getElementById('withdrawAccountName').value.trim();

            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
                html: `
                    <div class="text-left space-y-3">
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <p class="font-semibold text-orange-800 mb-3 text-center">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</span>
                                    <span class="font-semibold">‡∏ø${formatCurrency(amount)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</span>
                                    <span class="font-semibold">${bank}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span>
                                    <span class="font-semibold font-mono">${formatAccountNumber(accountNumber)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span>
                                    <span class="font-semibold">${accountName}</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-center space-x-4 text-sm text-blue-800">
                                <div class="flex items-center">
                                    <i class="fas fa-clock mr-1"></i>
                                    <span>1-2 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-gift mr-1"></i>
                                    <span>‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°: ‡∏ü‡∏£‡∏µ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô',
                cancelButtonText: '‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#f59e0b',
                cancelButtonColor: '#6b7280',
                width: '90%'
            });

            if (result.isConfirmed) {
                setProcessing(true); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
                retryCount = 0;
                
                try {
                    // Show loading
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...',
                        html: `
                            <div class="text-center">
                                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mb-4"></div>
                                <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                                <p class="text-sm text-gray-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
                            </div>
                        `,
                        allowOutsideClick: false,
                        showConfirmButton: false
                    });

                    // Create payload matching the GAS parameter structure
                    const payload = {
                        action: 'withdrawal',
                        userId: userData.userId,
                        amount: amount.toString(),
                        bank: bank,
                        account: accountNumber,
                        accountName: accountName,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        referrer: document.referrer || 'direct'
                    };

                    console.log('Sending withdraw request:', payload);

                    // Try API call with improved error handling
                    let apiResponse;
                    let apiSuccess = false;

                    try {
                        console.log('Attempting API call...');
                        apiResponse = await makeAPICall(payload);
                        
                        if (apiResponse && (apiResponse.success || apiResponse.success !== false)) {
                            apiSuccess = true;
                            console.log('API call successful:', apiResponse);
                        } else {
                            console.log('API returned error:', apiResponse);
                            // Don't throw error immediately, try verification first
                        }
                    } catch (apiError) {
                        console.log('API call failed, but continuing with verification:', apiError);
                        // Don't throw error, try verification anyway
                    }

                    // Wait for server processing
                    console.log('Waiting for server processing...');
                    await new Promise(resolve => setTimeout(resolve, 3000));

                    // Try to verify the transaction by checking updated balance
                    let verificationSuccess = false;
                    let newBalance = walletData.balance;
                    
                    try {
                        console.log('Verifying transaction...');
                        const verifyUrl = `${API_URL}?action=getWallet&userId=${encodeURIComponent(userData.userId)}&t=${Date.now()}`;
                        console.log('Verification URL:', verifyUrl);
                        
                        const verifyResponse = await fetch(verifyUrl, {
                            method: 'GET',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });
                        
                        if (verifyResponse.ok) {
                            const verifyText = await verifyResponse.text();
                            console.log('Verify raw response:', verifyText);
                            
                            try {
                                const verifyData = JSON.parse(verifyText);
                                console.log('Verify parsed data:', verifyData);
                                
                                if (verifyData.success && verifyData.balance !== undefined) {
                                    newBalance = parseFloat(verifyData.balance) || 0;
                                    const expectedBalance = walletData.balance - amount;
                                    const balanceDiff = Math.abs(newBalance - expectedBalance);
                                    
                                    console.log(`Balance verification: ${walletData.balance} -> ${newBalance} (expected: ${expectedBalance}, diff: ${balanceDiff})`);
                                    
                                    // Allow for small floating point differences
                                    if (balanceDiff <= 1) {
                                        verificationSuccess = true;
                                        console.log('Balance verification successful');
                                    } else {
                                        console.log('Balance verification failed - amount mismatch');
                                    }
                                } else {
                                    console.log('Verify response missing success or balance:', verifyData);
                                }
                            } catch (parseError) {
                                console.log('Failed to parse verify response as JSON:', parseError);
                            }
                        } else {
                            console.log('Verify response not ok:', verifyResponse.status, verifyResponse.statusText);
                        }
                    } catch (verifyError) {
                        console.log('Balance verification failed:', verifyError);
                    }

                    // Determine overall success
                    const overallSuccess = apiSuccess || verificationSuccess;
                    
                    if (overallSuccess) {
                        // Update local balance if verification was successful
                        if (verificationSuccess) {
                            walletData.balance = newBalance;
                            document.getElementById('withdrawBalance').textContent = '‡∏ø' + formatCurrency(newBalance);
                        }

                        // Show success message
                        await Swal.fire({
                            icon: 'success',
                            title: 'üéâ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                            html: `
                                <div class="text-center space-y-4">
                                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                        <h4 class="font-semibold text-green-800 mb-3">üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠</h4>
                                        <div class="text-left space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</span>
                                                <span class="font-bold text-green-700">‡∏ø${formatCurrency(amount)}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</span>
                                                <span class="font-semibold">${bank}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span>
                                                <span class="font-mono">${formatAccountNumber(accountNumber)}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span>
                                                <span class="font-semibold">${accountName}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                        <h4 class="font-semibold text-blue-800 mb-2">‚è∞ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ</h4>
                                        <div class="text-sm text-blue-700 space-y-1">
                                            <p>‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                                            <p>üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
                                            <p>üí∞ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: 1-2 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</p>
                                        </div>
                                    </div>
                                    ${verificationSuccess ? 
                                        '<div class="bg-green-50 p-3 rounded-lg border border-green-200"><p class="text-sm text-green-800"><i class="fas fa-check-circle mr-1"></i>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß</p></div>' : 
                                        '<div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200"><p class="text-sm text-yellow-800"><i class="fas fa-info-circle mr-1"></i>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>'
                                    }
                                    ${apiSuccess && verificationSuccess ? 
                                        '<div class="bg-green-50 p-3 rounded-lg border border-green-200"><p class="text-sm text-green-800"><i class="fas fa-thumbs-up mr-1"></i>‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà</p></div>' : 
                                        apiSuccess ? 
                                            '<div class="bg-blue-50 p-3 rounded-lg border border-blue-200"><p class="text-sm text-blue-800"><i class="fas fa-info-circle mr-1"></i>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p></div>' :
                                            '<div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200"><p class="text-sm text-yellow-800"><i class="fas fa-check mr-1"></i>‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</p></div>'
                                    }
                                </div>
                            `,
                            confirmButtonText: 'üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å',
                            confirmButtonColor: '#10b981',
                            allowOutsideClick: false,
                            width: '90%'
                        });
                        
                        window.location.href = 'index.html';
                    } else {
                        // Both API call and verification failed
                        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    }
                    
                } catch (error) {
                    const errorInfo = logError('submitWithdraw', error, {
                        amount,
                        bank,
                        accountNumber,
                        accountName,
                        retryCount
                    });
                    
                    // Show detailed error with troubleshooting steps
                    await Swal.fire({
                        icon: 'error',
                        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        html: `
                            <div class="text-center space-y-3">
                                <p class="text-gray-600">${error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'}</p>
                                
                                <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                                    <p class="text-sm text-red-800 font-semibold mb-2">
                                        <i class="fas fa-bug mr-1"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                                    </p>
                                    <div class="text-xs text-left text-red-700 space-y-1">
                                        <p><strong>Error:</strong> ${errorInfo.message}</p>
                                        <p><strong>User ID:</strong> ${userData.userId || '‡πÑ‡∏°‡πà‡∏û‡∏ö'}</p>
                                        <p><strong>API URL:</strong> ${API_URL}</p>
                                        <p><strong>Retry Count:</strong> ${errorInfo.retryCount}/${MAX_RETRIES}</p>
                                        <p><strong>Timestamp:</strong> ${errorInfo.timestamp}</p>
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                                    <p class="text-sm font-semibold text-yellow-800 mb-2">üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</p>
                                    <div class="text-xs text-left text-yellow-700 space-y-1">
                                        <p>1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</p>
                                        <p>2. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</p>
                                        <p>3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</p>
                                        <p>4. ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô</p>
                                    </div>
                                </div>
                                
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                    <p class="text-sm text-blue-800">
                                        <i class="fas fa-phone mr-1"></i>
                                        ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô: support@example.com
                                    </p>
                                </div>
                            </div>
                        `,
                        confirmButtonText: 'üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà',
                        showCancelButton: true,
                        cancelButtonText: 'üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å',
                        confirmButtonColor: '#f59e0b',
                        cancelButtonColor: '#6b7280',
                        width: '90%'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Reset processing flag and try again
                            setProcessing(false);
                            setTimeout(() => submitWithdraw(), 500);
                        } else {
                            window.location.href = 'index.html';
                        }
                    });
                } finally {
                    setProcessing(false); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
                }
            }
        }

        // Load Wallet Data with enhanced error handling
        async function loadWalletData() {
            try {
                console.log('Loading wallet data for user:', userData.userId);
                
                const response = await fetch(`${API_URL}?action=getWallet&userId=${userData.userId}&t=${Date.now()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Wallet data response:', data);
                
                if (data.success) {
                    walletData.balance = parseFloat(data.balance) || 0;
                    document.getElementById('withdrawBalance').textContent = '‡∏ø' + formatCurrency(walletData.balance);
                    
                    createQuickAmountButtons();
                    updateButtonState();
                } else {
                    throw new Error(data.message || 'Failed to load wallet data');
                }
            } catch (error) {
                const errorInfo = logError('loadWalletData', error, {
                    apiUrl: API_URL,
                    userId: userData.userId
                });
                
                await Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    html: `
                        <div class="text-center space-y-3">
                            <p class="text-gray-600">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ</p>
                            <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                                <p class="text-sm text-red-800 font-semibold mb-2">
                                    <i class="fas fa-bug mr-1"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                                </p>
                                <div class="text-xs text-left text-red-700">
                                    <p><strong>Error:</strong> ${errorInfo.message}</p>
                                    <p><strong>API:</strong> ${errorInfo.apiUrl}</p>
                                    <p><strong>User ID:</strong> ${errorInfo.userId || '‡πÑ‡∏°‡πà‡∏û‡∏ö'}</p>
                                </div>
                            </div>
                            <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                                <p class="text-sm text-yellow-800">
                                    <i class="fas fa-lightbulb mr-1"></i>
                                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                                </p>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä',
                    confirmButtonColor: '#f59e0b',
                    width: '90%'
                }).then(() => {
                    window.location.reload();
                });
            }
        }

        // Initialize LIFF with enhanced error handling
        window.onload = async function() {
            try {
                console.log('Starting LIFF initialization...');
                console.log('LIFF ID:', LIFF_ID);
                
                if (typeof liff === 'undefined') {
                    throw new Error('LIFF SDK not loaded');
                }
                
                await liff.init({ liffId: LIFF_ID });
                console.log('LIFF initialized successfully');
                
                if (liff.isLoggedIn()) {
                    console.log('User is logged in');
                    await initApp();
                } else {
                    console.log('User not logged in, redirecting to login...');
                    liff.login();
                }
            } catch (err) {
                const errorInfo = logError('LIFF Init', err, {
                    liffId: LIFF_ID,
                    liffDefined: typeof liff !== 'undefined'
                });
                
                await Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    html: `
                        <div class="text-center space-y-3">
                            <p class="text-gray-600">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ</p>
                            <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                                <p class="text-sm text-red-800 font-semibold mb-2">
                                    <i class="fas fa-bug mr-1"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ
                                </p>
                                <div class="text-xs text-left text-red-700 space-y-1">
                                    <p><strong>Error:</strong> ${errorInfo.message}</p>
                                    <p><strong>LIFF ID:</strong> ${errorInfo.liffId || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤'}</p>
                                    <p><strong>LIFF SDK:</strong> ${errorInfo.liffDefined ? '‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß' : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î'}</p>
                                </div>
                            </div>
                        </div>
                    `,
                    confirmButtonColor: '#ef4444',
                    width: '90%'
                });
            }
        };

        // Initialize App with enhanced error handling
        async function initApp() {
            try {
                console.log('Initializing app...');
                
                const profile = await liff.getProfile();
                userData = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl
                };

                console.log('User profile loaded:', userData);

                if (!API_URL) {
                    throw new Error('API_URL not configured');
                }

                await loadWalletData();

                if (walletData.balance < 100) {
                    await Swal.fire({
                        icon: 'warning',
                        title: 'üí∞ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠',
                        html: `
                            <div class="text-center space-y-4">
                                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                    <p class="text-yellow-800 mb-2">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span class="font-bold">‡∏ø${formatCurrency(walletData.balance)}</span></p>
                                    <p class="text-yellow-700 text-sm">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô: <span class="font-semibold">‡∏ø100.00</span></p>
                                </div>
                                <p class="text-gray-600">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 100 ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                            </div>
                        `,
                        confirmButtonText: 'üíé ‡πÑ‡∏õ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô',
                        showCancelButton: true,
                        cancelButtonText: 'üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å',
                        confirmButtonColor: '#f59e0b',
                        cancelButtonColor: '#6b7280'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = 'topup.html';
                        } else {
                            window.location.href = 'index.html';
                        }
                    });
                    return;
                }

                setupEventListeners();

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
            } catch (error) {
                const errorInfo = logError('initApp', error, {
                    hasApiUrl: !!API_URL
                });
                
                await Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    html: `
                        <div class="text-center space-y-3">
                            <p class="text-gray-600">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡πÑ‡∏î‡πâ</p>
                            <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                                <p class="text-sm text-red-800 font-semibold mb-2">
                                    <i class="fas fa-bug mr-1"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
                                </p>
                                <div class="text-xs text-left text-red-700 space-y-1">
                                    <p><strong>Error:</strong> ${errorInfo.message}</p>
                                    <p><strong>API Configured:</strong> ${errorInfo.hasApiUrl ? '‡πÉ‡∏ä‡πà' : '‡πÑ‡∏°‡πà'}</p>
                                </div>
                            </div>
                            <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                                <p class="text-sm text-yellow-800">
                                    <i class="fas fa-lightbulb mr-1"></i>
                                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
                                </p>
                            </div>
                        </div>
                    `,
                    confirmButtonColor: '#ef4444',
                    width: '90%'
                });
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            const amountInput = document.getElementById('withdrawAmount');
            const bankSelect = document.getElementById('withdrawBank');
            const accountInput = document.getElementById('withdrawAccount');
            const nameInput = document.getElementById('withdrawAccountName');
            const termsCheckbox = document.getElementById('acceptTerms');

            amountInput.addEventListener('input', function() {
                validateAmount();
                updateButtonState();
            });

            amountInput.addEventListener('blur', validateAmount);

            bankSelect.addEventListener('change', function() {
                validateBank();
                updateButtonState();
            });

            accountInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '');
                validateAccount();
                updateButtonState();
            });

            accountInput.addEventListener('blur', validateAccount);

            nameInput.addEventListener('input', function() {
                validateAccountName();
                updateButtonState();
            });

            nameInput.addEventListener('blur', validateAccountName);

            termsCheckbox.addEventListener('change', function() {
                validateTerms();
                updateButtonState();
            });

            updateButtonState();
        }
    </script>
</body>
</html>

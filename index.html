<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบออมทอง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-100">
    <!-- Mobile Only Warning Screen -->
    <div id="mobileOnlyWarning" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
            <div class="mb-6">
                <i class="fas fa-mobile-alt text-6xl text-blue-500 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">แอปพลิเคชันสำหรับมือถือเท่านั้น</h2>
                <p class="text-gray-600 mb-6">กรุณาเข้าใช้งานระบบออมทองผ่านมือถือหรือแท็บเล็ตเท่านั้น</p>
            </div>
            <div class="text-left bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-gray-800 mb-2">วิธีการเข้าใช้งาน:</h3>
                <ul class="text-sm text-gray-600 space-y-1">
                    <li>• เปิดผ่าน LINE Official Account</li>
                    <li>• ใช้งานบนมือถือหรือแท็บเล็ต</li>
                    <li>• ตรวจสอบให้แน่ใจว่าเปิดผ่าน LIFF</li>
                </ul>
            </div>
            <div class="text-xs text-gray-500">
                <p>หากคุณใช้งานบนมือถืออยู่แล้ว กรุณารีเฟรชหน้าเว็บ</p>
            </div>
        </div>
    </div>

    <!-- Optimized Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-gradient-to-br from-yellow-400 to-amber-500 z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="relative mb-6">
                <i class="fas fa-coins text-8xl text-white animate-bounce"></i>
                <div class="absolute -top-2 -right-2 w-6 h-6 bg-white rounded-full animate-ping"></div>
            </div>
            <h2 class="text-white text-2xl font-bold mb-2">ระบบออมทอง</h2>
            <p class="text-white/90 mb-6">กำลังเริ่มต้นระบบ...</p>
            
            <!-- Progress Bar -->
            <div class="w-64 bg-white/20 rounded-full h-3 mb-4">
                <div id="loadingProgress" class="bg-white h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
            
            <!-- Loading Steps -->
            <div class="text-white/80 text-sm">
                <span id="loadingText">เตรียมการระบบ...</span>
            </div>
        </div>
    </div>

    <!-- Main App (hidden by default) -->
    <div id="app" class="hidden min-h-screen flex-col">
        <!-- Header -->
        <div class="bg-gradient-to-r from-yellow-400 to-amber-500 p-4 shadow-lg">
            <div class="flex items-center space-x-3">
                <img id="userPic" src="https://cdn-icons-gif.flaticon.com/11255/11255995.gif" alt="Profile" class="w-12 h-12 rounded-full border-2 border-white">
                <div class="flex-1">
                    <h1 class="text-white font-bold text-lg">ระบบออมทอง</h1>
                    <p id="userName" class="text-white text-sm"></p>
                </div>
                <div class="text-right">
                    <p id="totalGold" class="text-white font-bold text-xl">จำนว:0 กรัม</p>
                    <p id="totalValue" class="text-white text-sm">มูลค่า: ฿0</p>
                </div>
            </div>
        </div>

        <!-- Portfolio Content -->
        <div id="portfolioContent" class="p-4 page-container flex-1">
            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="navigateToPage('buy.html')" class="bg-green-500 text-white py-4 rounded-lg font-semibold hover:bg-green-600 transition card-hover btn-animate">
                    <i class="fas fa-plus-circle mr-2"></i>ซื้อทอง
                </button>
                <button onclick="navigateToPage('sell.html')" class="bg-red-500 text-white py-4 rounded-lg font-semibold hover:bg-red-600 transition card-hover btn-animate">
                    <i class="fas fa-minus-circle mr-2"></i>ขายทอง
                </button>
            </div>

            <!-- Gold Balance Cards -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">ทองคำแท่ง</p>
                            <p id="barGold" class="text-xl font-bold text-yellow-600">0 กรัม</p>
                        </div>
                        <i class="fas fa-coins text-3xl text-yellow-500"></i>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">ทองรูปพรรณ</p>
                            <p id="ornamentGold" class="text-xl font-bold text-yellow-600">0 กรัม</p>
                        </div>
                        <i class="fas fa-gem text-3xl text-yellow-500"></i>
                    </div>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="bg-white rounded-lg shadow p-4 card-hover">
                <h3 class="font-bold text-lg mb-4"><i class="fas fa-history mr-2"></i>ประวัติการทำรายการ</h3>
                <div id="transactionList" class="space-y-3">
                    <p class="text-gray-500 text-center">กำลังโหลด...</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="p-4 hidden page-container flex-1">
            <p class="text-center text-gray-500">กำลังโหลดข้อมูลราคาทอง...</p>
        </div>

        <!-- Wallet Content -->
        <div id="walletContent" class="p-4 hidden page-container flex-1">
            <!-- Wallet Balance -->
            <div class="bg-white rounded-lg shadow p-6 mb-4 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">ยอดเงินคงเหลือ</p>
                        <p id="walletBalance" class="text-3xl font-bold text-green-600">฿0.00</p>
                    </div>
                    <i class="fas fa-wallet text-5xl text-green-500"></i>
                </div>
            </div>

            <!-- Wallet Actions -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="navigateToPage('topup.html')" class="bg-blue-500 text-white py-4 rounded-lg font-semibold hover:bg-blue-600 transition card-hover btn-animate">
                    <i class="fas fa-plus mr-2"></i>เติมเงิน
                </button>
                <button onclick="navigateToPage('withdraw.html')" class="bg-orange-500 text-white py-4 rounded-lg font-semibold hover:bg-orange-600 transition card-hover btn-animate">
                    <i class="fas fa-minus mr-2"></i>ถอนเงิน
                </button>
            </div>

            <!-- Wallet History -->
            <div class="bg-white rounded-lg shadow p-4 card-hover">
                <h3 class="font-bold text-lg mb-4"><i class="fas fa-list mr-2"></i>ประวัติกระเป๋าเงิน</h3>
                <div id="walletHistory" class="space-y-3">
                    <p class="text-gray-500 text-center">กำลังโหลด...</p>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t z-10">
            <div class="flex">
                <button id="portfolioTab" onclick="switchTab('portfolio')" class="tab flex-1 py-3 text-center font-semibold tab-active btn-animate">
                    <i class="fas fa-chart-pie mr-2"></i>พอร์ตโฟลิโอ
                </button>
                <button id="dashboardTab" onclick="switchTab('dashboard')" class="tab flex-1 py-3 text-center font-semibold btn-animate">
                    <i class="fas fa-chart-line mr-2"></i>ราคาทอง
                </button>
                <button id="walletTab" onclick="switchTab('wallet')" class="tab flex-1 py-3 text-center font-semibold btn-animate">
                    <i class="fas fa-wallet mr-2"></i>กระเป๋าเงิน
                </button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script>
        // Global Variables
        let userData = {};
        let currentGoldData = { totalGold: 0, avgPrice: 0, balances: { bar: { totalGold: 0, avgPrice: 0 }, ornament: { totalGold: 0, avgPrice: 0 } } };
        let walletData = { balance: 0, transactions: [] };

        // Optimized Loading System
        let loadingSteps = 0;
        const totalSteps = 3; // ลดจำนวนขั้นตอนลง
        const loadingMessages = [
            'เชื่อมต่อระบบ...',
            'โหลดข้อมูลผู้ใช้...',
            'เสร็จสิ้น!'
        ];

        function updateLoadingProgress(message) {
            const progressBar = document.getElementById('loadingProgress');
            const loadingText = document.getElementById('loadingText');
            
            if (progressBar && loadingText) {
                loadingSteps++;
                const progress = Math.min((loadingSteps / totalSteps) * 100, 100);
                progressBar.style.width = progress + '%';
                
                if (message) {
                    loadingText.textContent = message;
                } else if (loadingMessages[loadingSteps - 1]) {
                    loadingText.textContent = loadingMessages[loadingSteps - 1];
                }
            }
            
            // ซ่อน loading เมื่อเสร็จทั้งหมด
            if (loadingSteps >= totalSteps) {
                setTimeout(() => {
                    hideLoading();
                }, 300); // ลดเวลาหน่วง
            }
        }

        function hideLoading() {
            const loadingElement = document.getElementById('loading');
            const appElement = document.getElementById('app');
            
            if (loadingElement && appElement) {
                loadingElement.style.opacity = '0';
                setTimeout(() => {
                    loadingElement.classList.add('hidden');
                    appElement.classList.remove('hidden');
                }, 200);
            }
        }

        // เริ่มต้น Progress ทันที
        function startProgress() {
            updateLoadingProgress('เริ่มต้นระบบ...');
        }

        // Mobile Device Detection (ปรับปรุงให้เร็วขึ้น)
        function detectMobileDevice() {
            const userAgent = navigator.userAgent;
            const mobileRegex = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
            const isMobileUserAgent = mobileRegex.test(userAgent);
            const isMobileScreen = window.screen.width <= 768;
            const isTouchDevice = 'ontouchstart' in window;
            
            return isMobileUserAgent || (isMobileScreen && isTouchDevice);
        }

        function isPCDevice() {
            const userAgent = navigator.userAgent;
            const desktopOS = /Windows NT|Macintosh|Linux/i.test(userAgent);
            const largeScreen = window.screen.width >= 1024;
            const hasMouseInput = window.matchMedia('(pointer: fine)').matches;
            
            return (desktopOS && largeScreen) || (largeScreen && hasMouseInput);
        }

        function showMobileOnlyWarning() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('mobileOnlyWarning').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        function performDeviceCheck() {
            const isMobile = detectMobileDevice();
            const isPC = isPCDevice();
            
            if (isPC && !isMobile) {
                showMobileOnlyWarning();
                return false;
            }
            
            if (window.screen.width > 1200) {
                showMobileOnlyWarning();
                return false;
            }
            
            return true;
        }

        // Navigation function
        function navigateToPage(page) {
            window.location.href = page;
        }

        // Tab switching
        function switchTab(tab) {
            const portfolioTab = document.getElementById('portfolioTab');
            const dashboardTab = document.getElementById('dashboardTab');
            const walletTab = document.getElementById('walletTab');
            const portfolioContent = document.getElementById('portfolioContent');
            const dashboardContent = document.getElementById('dashboardContent');
            const walletContent = document.getElementById('walletContent');

            // Reset all tabs
            portfolioTab.classList.remove('tab-active');
            dashboardTab.classList.remove('tab-active');
            walletTab.classList.remove('tab-active');
            portfolioContent.classList.add('hidden');
            dashboardContent.classList.add('hidden');
            walletContent.classList.add('hidden');

            // Activate selected tab
            if (tab === 'portfolio') {
                portfolioTab.classList.add('tab-active');
                portfolioContent.classList.remove('hidden');
            } else if (tab === 'dashboard') {
                dashboardTab.classList.add('tab-active');
                dashboardContent.classList.remove('hidden');
                loadDashboard();
            } else if (tab === 'wallet') {
                walletTab.classList.add('tab-active');
                walletContent.classList.remove('hidden');
                loadWalletData();
            }
        }

        // Load dashboard content
        function loadDashboard() {
            window.location.href = 'dashboard.html';
        }

        // เริ่มต้นระบบทันทีเมื่อโหลดหน้า
        document.addEventListener('DOMContentLoaded', function() {
            startProgress();
        });

        // Optimized LIFF Initialize
        window.onload = async function() {
            try {
                // ตรวจสอบอุปกรณ์อย่างรวดเร็ว
                if (!performDeviceCheck()) {
                    return;
                }

                // เริ่ม LIFF ทันที
                updateLoadingProgress('เชื่อมต่อ LINE...');
                
                if (typeof liff !== 'undefined' && window.LIFF_ID) {
                    await liff.init({ liffId: window.LIFF_ID });
                    
                    if (liff.isLoggedIn()) {
                        updateLoadingProgress('โหลดข้อมูลผู้ใช้...');
                        await initAppFast();
                    } else {
                        liff.login();
                    }
                } else {
                    // ถ้าไม่มี LIFF ก็ให้แสดงแอปเลย (สำหรับ demo)
                    console.warn('LIFF not available, showing demo mode');
                    await initDemoMode();
                }
            } catch (err) {
                console.error('LIFF init failed:', err);
                // แสดงแอปแม้เกิด error
                await initDemoMode();
            }
        };

        // เริ่มต้นแอปแบบเร็ว (โหลดเฉพาะข้อมูลจำเป็น)
        async function initAppFast() {
            try {
                const profile = await liff.getProfile();
                userData = {
                    userId: profile.userId,
                    name: profile.displayName,
                    picture: profile.pictureUrl
                };
                
                // อัพเดท UI ทันที
                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userPic').src = userData.picture;
                
                updateLoadingProgress('เสร็จสิ้น!');
                
                // โหลดข้อมูลใน background หลังจากแสดงแอปแล้ว
                setTimeout(() => {
                    loadDataInBackground();
                }, 100);
                
            } catch (error) {
                console.error('Error initializing app:', error);
                await initDemoMode();
            }
        }

        // โหลดข้อมูลใน background
        async function loadDataInBackground() {
            try {
                // โหลดข้อมูลแบบ parallel และไม่บล็อก UI
                const promises = [
                    loadGoldDataSilent(),
                    loadTransactionsSilent(),
                    loadWalletDataSilent()
                ];
                
                await Promise.allSettled(promises);
            } catch (error) {
                console.error('Background loading error:', error);
            }
        }

        // Demo mode สำหรับกรณีที่ไม่มี LIFF
        async function initDemoMode() {
            userData = {
                userId: 'demo_user',
                name: 'ผู้ใช้ทดสอบ',
                picture: 'https://cdn-icons-gif.flaticon.com/11255/11255995.gif'
            };
            
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userPic').src = userData.picture;
            
            updateLoadingProgress('เสร็จสิ้น!');
            
            // โหลดข้อมูล demo
            setTimeout(() => {
                loadDemoData();
            }, 100);
        }

        // โหลดข้อมูล demo
        function loadDemoData() {
            document.getElementById('totalGold').textContent = '15.50 กรัม';
            document.getElementById('totalValue').textContent = 'มูลค่า: ฿42,500';
            document.getElementById('barGold').textContent = '10.00 กรัม';
            document.getElementById('ornamentGold').textContent = '5.50 กรัม';
            document.getElementById('walletBalance').textContent = '฿25,000.00';
            
            // แสดงข้อมูล demo ในประวัติ
            const transactionList = document.getElementById('transactionList');
            transactionList.innerHTML = '<p class="text-gray-500 text-center">ไม่มีข้อมูลในโหมดทดสอบ</p>';
            
            const walletHistory = document.getElementById('walletHistory');
            walletHistory.innerHTML = '<p class="text-gray-500 text-center">ไม่มีข้อมูลในโหมดทดสอบ</p>';
        }

        // API call function with faster timeout
        async function makeApiCall(url, options = {}) {
            const defaultOptions = {
                method: 'GET',
                mode: 'cors',
                credentials: 'omit',
                headers: { 'Accept': 'application/json' },
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // ลด timeout เหลือ 5 วินาที
                
                const response = await fetch(url, {
                    ...finalOptions,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                return JSON.parse(text);
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Request timeout');
                }
                throw error;
            }
        }

        // Silent loading functions (ไม่แสดง error popup)
        async function loadGoldDataSilent() {
            try {
                if (!window.API_URL) return;
                
                const data = await makeApiCall(`${window.API_URL}?action=getBalance&userId=${userData.userId}`);
                
                if (data.success) {
                    currentGoldData.totalGold = data.totalGold || 0;
                    currentGoldData.avgPrice = data.avgPrice || 0;
                    currentGoldData.balances = data.balances || { bar: { totalGold: 0, avgPrice: 0 }, ornament: { totalGold: 0, avgPrice: 0 } };
                    
                    const gramsPerBaht = window.GRAMS_PER_BAHT || 15.16;
                    const totalValue = (currentGoldData.totalGold / gramsPerBaht) * currentGoldData.avgPrice;
                    
                    document.getElementById('totalGold').textContent = formatNumber(currentGoldData.totalGold) + ' กรัม';
                    document.getElementById('totalValue').textContent = 'มูลค่า: ฿' + formatCurrency(totalValue);
                    document.getElementById('barGold').textContent = formatNumber(currentGoldData.balances.bar?.totalGold || 0) + ' กรัม';
                    document.getElementById('ornamentGold').textContent = formatNumber(currentGoldData.balances.ornament?.totalGold || 0) + ' กรัม';
                }
            } catch (error) {
                console.error('Silent gold data loading failed:', error);
            }
        }

        async function loadWalletDataSilent() {
            try {
                if (!window.API_URL) return;
                
                const data = await makeApiCall(`${window.API_URL}?action=getWallet&userId=${userData.userId}`);
                
                if (data.success) {
                    walletData.balance = data.balance || 0;
                    walletData.transactions = data.transactions || [];
                    document.getElementById('walletBalance').textContent = '฿' + formatCurrency(walletData.balance);

                    const walletHistory = document.getElementById('walletHistory');
                    walletHistory.innerHTML = '';

                    if (walletData.transactions.length === 0) {
                        walletHistory.innerHTML = '<p class="text-gray-500 text-center">ยังไม่มีรายการ</p>';
                        return;
                    }

                    walletData.transactions.forEach(transaction => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                        
                        let typeColor, typeIcon;
                        if (transaction.type === 'เติมเงิน') {
                            typeColor = 'text-green-600';
                            typeIcon = 'fa-plus-circle';
                        } else if (transaction.type === 'อนุมัติถอนเงิน'|| transaction.type === 'อนุมัติเติมเงิน' ) {
                            typeColor = 'text-green-600';
                            typeIcon = 'fas fa-check-circle';
                        } else if (transaction.type === 'ซื้อทอง' ) {
                            typeColor = 'text-blue-600';
                            typeIcon = 'fas fa-coins';
                         } else if (transaction.type === 'ขายทอง' ) {
                            typeColor = 'text-red-600';
                            typeIcon = 'fas fa-coins';
                        } else {
                            typeColor = 'text-red-600';
                            typeIcon = 'fa-minus-circle';
                        }

                        let statusColor;
                        if (transaction.status === 'สำเร็จ' || transaction.status === 'อนุมัติแล้ว') {
                            statusColor = 'text-green-500';
                        } else if (transaction.status === 'รอดำเนินการ' || transaction.status === 'รอการอนุมัติ') {
                            statusColor = 'text-yellow-500';
                        } else if (transaction.status === 'ยกเลิก' || transaction.status === 'ปฏิเสธ') {
                            statusColor = 'text-red-500';
                        } else {
                            statusColor = 'text-gray-500';
                        }

                        div.innerHTML = `
                            <div>
                                <p class="font-semibold ${typeColor}">
                                    <i class="fas ${typeIcon} mr-1"></i>
                                    ${transaction.type}
                                </p>
                                <p class="text-sm text-gray-500">${transaction.date}</p>
                                <p class="text-xs ${statusColor}">${transaction.status}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">฿${formatCurrency(transaction.amount)}</p>
                                <p class="text-sm text-gray-500">${transaction.bank || ''}</p>
                            </div>
                        `;
                        walletHistory.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Silent wallet data loading failed:', error);
            }
        }

        async function loadTransactionsSilent() {
            try {
                if (!window.API_URL) return;
                
                const data = await makeApiCall(`${window.API_URL}?action=getTransactions&userId=${userData.userId}`);
                
                if (data.success) {
                    const transactionList = document.getElementById('transactionList');
                    transactionList.innerHTML = '';
                    
                    if (data.transactions.length === 0) {
                        transactionList.innerHTML = '<p class="text-gray-500 text-center">ยังไม่มีรายการ</p>';
                        return;
                    }
                    
                    data.transactions.forEach(transaction => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                        const typeColor = transaction.type === 'ซื้อ' ? 'text-green-600' : 'text-red-600';
                        const typeIcon = transaction.type === 'ซื้อ' ? 'fa-plus' : 'fa-minus';
                        const goldTypeText = transaction.goldType === 'bar' ? 'ทองคำแท่ง' : 'ทองรูปพรรณ';
                        
                        div.innerHTML = `
                            <div>
                                <p class="font-semibold ${typeColor}">
                                    <i class="fas ${typeIcon} mr-1"></i>
                                    ${transaction.type} ${formatNumber(transaction.amount)} กรัม (${goldTypeText})
                                </p>
                                <p class="text-sm text-gray-500">${transaction.date}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">฿${formatCurrency(transaction.price)}/บาท</p>
                                <p class="text-sm text-gray-500">฿${formatCurrency(transaction.total)}</p>
                            </div>
                        `;
                        transactionList.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Silent transactions loading failed:', error);
            }
        }

        // Wallet loading with error handling (for tab switching)
        async function loadWalletData() {
            try {
                await loadWalletDataSilent();
            } catch (error) {
                console.error('Error loading wallet data:', error);
                document.getElementById('walletBalance').textContent = '฿0.00';
                document.getElementById('walletHistory').innerHTML = '<p class="text-gray-500 text-center">ไม่สามารถโหลดข้อมูลได้</p>';
            }
        }

        // Fallback functions สำหรับกรณีที่ไม่มีไฟล์ utils.js
        if (typeof formatNumber === 'undefined') {
            window.formatNumber = function(num) {
                return num.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            };
        }

        if (typeof formatCurrency === 'undefined') {
            window.formatCurrency = function(amount) {
                return amount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            };
        }

        // Additional optimizations

        // Preload critical resources
        function preloadResources() {
            const criticalImages = [
                'https://cdn-icons-gif.flaticon.com/11255/11255995.gif'
            ];
            
            criticalImages.forEach(src => {
                const img = new Image();
                img.src = src;
            });
        }

        // Start preloading immediately
        preloadResources();

        // Optimize animations
        function enableHardwareAcceleration() {
            const style = document.createElement('style');
            style.textContent = `
                .card-hover, .btn-animate, #loading {
                    will-change: transform;
                    transform: translateZ(0);
                }
                
                .animate-bounce, .animate-ping {
                    will-change: transform;
                }
                
                #loadingProgress {
                    will-change: width;
                }
            `;
            document.head.appendChild(style);
        }

        enableHardwareAcceleration();

        // Monitor screen size changes (optimized)
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (window.innerWidth > 1200) {
                    showMobileOnlyWarning();
                }
            }, 250);
        });

        // Prevent context menu and text selection (optimized)
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('selectstart', e => e.preventDefault());

        // Disable developer tools (basic protection)
        document.addEventListener('keydown', function(e) {
            if (e.keyCode === 123 || 
                (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) ||
                (e.ctrlKey && e.keyCode === 85)) {
                e.preventDefault();
                return false;
            }
        });

        // Disable drag and drop
        document.addEventListener('dragstart', e => e.preventDefault());

        // Prevent zoom gestures
        document.addEventListener('gesturestart', e => e.preventDefault());
        document.addEventListener('gesturechange', e => e.preventDefault());
        document.addEventListener('gestureend', e => e.preventDefault());

        // Orientation change handler
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                if (window.innerWidth > 1200) {
                    showMobileOnlyWarning();
                }
            }, 500);
        });

        // Performance monitoring (optional)
        if (window.performance && window.performance.mark) {
            window.performance.mark('app-start');
            
            window.addEventListener('load', function() {
                window.performance.mark('app-loaded');
                window.performance.measure('app-load-time', 'app-start', 'app-loaded');
                
                const measure = window.performance.getEntriesByName('app-load-time')[0];
                console.log(`App loaded in ${measure.duration.toFixed(2)}ms`);
            });
        }

        // Service Worker registration (for caching - optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }

        // Cleanup function for better memory management
        window.addEventListener('beforeunload', function() {
            // Cancel any pending requests
            if (window.currentRequests) {
                window.currentRequests.forEach(request => {
                    if (request.abort) request.abort();
                });
            }
        });

        // Error boundary for uncaught errors
        window.addEventListener('error', function(e) {
            console.error('Uncaught error:', e.error);
            // Don't show error popup to user, just log it
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            // Don't show error popup to user, just log it
        });
    </script>
</body>
</html>

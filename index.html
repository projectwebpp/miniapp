<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบออมทอง</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style">
    
    <!-- Critical CSS inline -->
    <style>
        /* Critical above-the-fold styles */
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            margin: 0; 
            background: #f3f4f6; 
        }
        #loading { 
            position: fixed; 
            inset: 0; 
            background: white; 
            z-index: 50; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .hidden { display: none !important; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        /* Essential layout */
        .min-h-screen { min-height: 100vh; }
        .bg-gradient-to-r { background: linear-gradient(to right, #fbbf24, #f59e0b); }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .text-center { text-align: center; }
        .text-white { color: white; }
        .text-gray-600 { color: #4b5563; }
        .p-4 { padding: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-6xl { font-size: 3.75rem; }
        .text-lg { font-size: 1.125rem; }
        .font-bold { font-weight: 700; }
    </style>
    
    <!-- Non-critical CSS loaded asynchronously -->
    <link rel="stylesheet" href="https://cdn.tailwindcss.com" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" media="print" onload="this.media='all'">
    
    <!-- Fallback for CSS -->
    <noscript>
        <link rel="stylesheet" href="https://cdn.tailwindcss.com">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap">
    </noscript>
</head>
<body class="bg-gray-100">
    <!-- Optimized Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 bg-yellow-500 rounded-full animate-pulse mb-4 mx-auto flex items-center justify-center">
                <span class="text-white text-2xl">฿</span>
            </div>
            <p class="text-gray-600">กำลังโหลด...</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden min-h-screen">
        <!-- Header -->
        <div class="bg-gradient-to-r from-yellow-400 to-amber-500 p-4 shadow-lg">
            <div class="flex items-center space-x-3">
                <img id="userPic" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'%3E%3Ccircle cx='24' cy='24' r='24' fill='%23e5e7eb'/%3E%3C/svg%3E" alt="Profile" class="w-12 h-12 rounded-full border-2 border-white" loading="lazy">
                <div class="flex-1">
                    <h1 class="text-white font-bold text-lg">ระบบออมทอง</h1>
                    <p id="userName" class="text-white text-sm">กำลังโหลด...</p>
                </div>
                <div class="text-right">
                    <p id="totalGold" class="text-white font-bold text-xl">0 กรัม</p>
                    <p id="totalValue" class="text-white text-sm">มูลค่า: ฿0</p>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs flex bg-white border-b">
            <button id="portfolioTab" onclick="switchTab('portfolio')" class="tab flex-1 py-3 text-center font-semibold tab-active btn-animate">
                <i class="fas fa-chart-pie mr-2"></i>พอร์ตโฟลิโอ
            </button>
            <button id="dashboardTab" onclick="switchTab('dashboard')" class="tab flex-1 py-3 text-center font-semibold btn-animate">
                <i class="fas fa-chart-line mr-2"></i>ราคาทอง
            </button>
            <button id="walletTab" onclick="switchTab('wallet')" class="tab flex-1 py-3 text-center font-semibold btn-animate">
                <i class="fas fa-wallet mr-2"></i>กระเป๋าเงิน
            </button>
        </div>

        <!-- Portfolio Content -->
        <div id="portfolioContent" class="p-4 page-container">
            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="navigateToPage('buy.html')" class="bg-green-500 text-white py-4 rounded-lg font-semibold hover:bg-green-600 transition card-hover btn-animate">
                    <i class="fas fa-plus-circle mr-2"></i>ซื้อทอง
                </button>
                <button onclick="navigateToPage('sell.html')" class="bg-red-500 text-white py-4 rounded-lg font-semibold hover:bg-red-600 transition card-hover btn-animate">
                    <i class="fas fa-minus-circle mr-2"></i>ขายทอง
                </button>
            </div>

            <!-- Gold Balance Cards -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">ทองคำแท่ง</p>
                            <p id="barGold" class="text-xl font-bold text-yellow-600">0 กรัม</p>
                        </div>
                        <i class="fas fa-coins text-3xl text-yellow-500"></i>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">ทองรูปพรรณ</p>
                            <p id="ornamentGold" class="text-xl font-bold text-yellow-600">0 กrัม</p>
                        </div>
                        <i class="fas fa-gem text-3xl text-yellow-500"></i>
                    </div>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="bg-white rounded-lg shadow p-4 card-hover">
                <h3 class="font-bold text-lg mb-4"><i class="fas fa-history mr-2"></i>ประวัติการทำรายการ</h3>
                <div id="transactionList" class="space-y-3">
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="p-4 hidden page-container">
            <div class="animate-pulse">
                <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
            </div>
        </div>

        <!-- Wallet Content -->
        <div id="walletContent" class="p-4 hidden page-container">
            <!-- Wallet Balance -->
            <div class="bg-white rounded-lg shadow p-6 mb-4 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">ยอดเงินคงเหลือ</p>
                        <p id="walletBalance" class="text-3xl font-bold text-green-600">฿0.00</p>
                    </div>
                    <i class="fas fa-wallet text-5xl text-green-500"></i>
                </div>
            </div>

            <!-- Wallet Actions -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="navigateToPage('topup.html')" class="bg-blue-500 text-white py-4 rounded-lg font-semibold hover:bg-blue-600 transition card-hover btn-animate">
                    <i class="fas fa-plus mr-2"></i>เติมเงิน
                </button>
                <button onclick="navigateToPage('withdraw.html')" class="bg-orange-500 text-white py-4 rounded-lg font-semibold hover:bg-orange-600 transition card-hover btn-animate">
                    <i class="fas fa-minus mr-2"></i>ถอนเงิน
                </button>
            </div>

            <!-- Wallet History -->
            <div class="bg-white rounded-lg shadow p-4 card-hover">
                <h3 class="font-bold text-lg mb-4"><i class="fas fa-list mr-2"></i>ประวัติกระเป๋าเงิน</h3>
                <div id="walletHistory" class="space-y-3">
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Optimized Script Loading -->
    <script>
        // Performance optimization: Cache DOM elements
        const elements = {};
        const cache = new Map();
        
        // Utility functions moved inline for better performance
        const formatNumber = (num) => parseFloat(num).toFixed(2);
        const formatCurrency = (amount) => parseFloat(amount).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        // Global Variables with better initialization
        let userData = null;
        let currentGoldData = { 
            totalGold: 0, 
            avgPrice: 0, 
            balances: { 
                bar: { totalGold: 0, avgPrice: 0 }, 
                ornament: { totalGold: 0, avgPrice: 0 } 
            } 
        };
        let walletData = { balance: 0, transactions: [] };
        
        // Cache DOM elements on first access
        const getElement = (id) => {
            if (!elements[id]) {
                elements[id] = document.getElementById(id);
            }
            return elements[id];
        };

        // Optimized navigation with faster page transitions
        function navigateToPage(page) {
            // Add loading state before navigation
            document.body.style.opacity = '0.7';
            setTimeout(() => {
                window.location.href = page;
            }, 100);
        }

        // Optimized tab switching with better performance
        function switchTab(tab) {
            const tabElements = {
                portfolio: { tab: getElement('portfolioTab'), content: getElement('portfolioContent') },
                dashboard: { tab: getElement('dashboardTab'), content: getElement('dashboardContent') },
                wallet: { tab: getElement('walletTab'), content: getElement('walletContent') }
            };

            // Batch DOM operations
            requestAnimationFrame(() => {
                // Reset all tabs
                Object.values(tabElements).forEach(({ tab, content }) => {
                    tab.classList.remove('tab-active');
                    content.classList.add('hidden');
                });

                // Activate selected tab
                const selected = tabElements[tab];
                if (selected) {
                    selected.tab.classList.add('tab-active');
                    selected.content.classList.remove('hidden');
                    
                    // Lazy load content
                    if (tab === 'dashboard' && !cache.has('dashboard-loaded')) {
                        loadDashboard();
                        cache.set('dashboard-loaded', true);
                    } else if (tab === 'wallet' && !cache.has('wallet-loaded')) {
                        loadWalletData();
                        cache.set('wallet-loaded', true);
                    }
                }
            });
        }

        function loadDashboard() {
            // Optimize dashboard loading
            const dashboardContent = getElement('dashboardContent');
            dashboardContent.innerHTML = '<p class="text-center text-gray-500">กำลังโหลดข้อมูลราคาทอง...</p>';
            
            // Simulate faster loading or implement actual dashboard logic
            setTimeout(() => {
                dashboardContent.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow mb-4">
                        <h3 class="font-bold text-lg mb-2">ราคาทองคำวันนี้</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <p class="text-sm text-gray-500">ทองคำแท่ง</p>
                                <p class="text-xl font-bold text-yellow-600">฿32,000</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500">ทองรูปพรรณ</p>
                                <p class="text-xl font-bold text-yellow-600">฿32,500</p>
                            </div>
                        </div>
                    </div>
                `;
            }, 500);
        }

        // Optimized API calls with caching and better error handling
        async function fetchData(url, options = {}) {
            const cacheKey = url + JSON.stringify(options);
            
            // Check cache first
            if (cache.has(cacheKey) && options.useCache !== false) {
                return cache.get(cacheKey);
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
                
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Cache successful responses
                if (data.success) {
                    cache.set(cacheKey, data);
                }
                
                return data;
            } catch (error) {
                console.error('Fetch error:', error);
                return { success: false, error: error.message };
            }
        }

        // Optimized initialization with parallel loading
        window.onload = async function() {
            try {
                // Show loading immediately
                const loadingEl = getElement('loading');
                const appEl = getElement('app');
                
                // Load scripts asynchronously
                const loadScript = (src) => {
                    return new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = src;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                };

                // Load required scripts in parallel
                const scriptPromises = [
                    loadScript('https://static.line-scdn.net/liff/edge/2/sdk.js'),
                    loadScript('https://cdn.jsdelivr.net/npm/sweetalert2@11')
                ];

                await Promise.all(scriptPromises);

                // Initialize LIFF with timeout
                const liffPromise = new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error('LIFF init timeout')), 5000);
                    
                    // Assume LIFF_ID is defined in config.js or inline
                    const LIFF_ID = '1234567890-abcdefgh'; // Replace with actual LIFF ID
                    
                    liff.init({ liffId: LIFF_ID }).then(() => {
                        clearTimeout(timeout);
                        resolve();
                    }).catch(reject);
                });

                await liffPromise;

                // Check login status
                if (liff.isLoggedIn()) {
                    await initApp();
                } else {
                    liff.login();
                }
                
            } catch (err) {
                console.error('App initialization failed:', err);
                
                // Fallback initialization without LIFF
                await initAppFallback();
            }
        };

        // Fallback initialization for development/testing
        async function initAppFallback() {
            userData = {
                userId: 'test-user-id',
                name: 'ผู้ใช้ทดสอบ',
                picture: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48"%3E%3Ccircle cx="24" cy="24" r="24" fill="%23e5e7eb"/%3E%3C/svg%3E'
            };
            
            getElement('userName').textContent = userData.name;
            getElement('userPic').src = userData.picture;
            
            // Load data with fallback values
            await loadDataFallback();
            
            // Hide loading and show app
            getElement('loading').classList.add('hidden');
            getElement('app').classList.remove('hidden');
        }

        // Optimized app initialization with parallel data loading
        async function initApp() {
            try {
                const profile = await liff.getProfile();
                userData = {
                    userId: profile.userId,
                    name: profile.displayName,
                    picture: profile.pictureUrl
                };
                
                // Update UI immediately
                getElement('userName').textContent = userData.name;
                getElement('userPic').src = userData.picture;
                
                // Load all data in parallel for better performance
                const dataPromises = [
                    loadGoldData(),
                    loadTransactions(),
                    loadWalletData()
                ];
                
                await Promise.allSettled(dataPromises);
                
                // Hide loading and show app
                getElement('loading').classList.add('hidden');
                getElement('app').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error initializing app:', error);
                await initAppFallback();
            }
        }

        // Optimized data loading functions
        async function loadGoldData() {
            try {
                // Use fallback data if API is not available
                const API_URL = window.API_URL || '';
                if (!API_URL) {
                    loadGoldDataFallback();
                    return;
                }
                
                const data = await fetchData(`${API_URL}?action=getBalance&userId=${userData?.userId || 'test'}`);
                
                if (data.success) {
                    currentGoldData.totalGold = data.totalGold || 0;
                    currentGoldData.avgPrice = data.avgPrice || 0;
                    currentGoldData.balances = data.balances || { 
                        bar: { totalGold: 0, avgPrice: 0 }, 
                        ornament: { totalGold: 0, avgPrice: 0 } 
                    };
                    
                    updateGoldUI();
                } else {
                    loadGoldDataFallback();
                }
            } catch (error) {
                console.error('Error loading gold data:', error);
                loadGoldDataFallback();
            }
        }

        function loadGoldDataFallback() {
            // Set fallback data
            currentGoldData = {
                totalGold: 0,
                avgPrice: 32000,
                balances: {
                    bar: { totalGold: 0, avgPrice: 32000 },
                    ornament: { totalGold: 0, avgPrice: 32500 }
                }
            };
            updateGoldUI();
        }

        function updateGoldUI() {
            const GRAMS_PER_BAHT = 15.244; // Define this constant
            const totalValue = (currentGoldData.totalGold / GRAMS_PER_BAHT) * currentGoldData.avgPrice;
            
            // Batch DOM updates
            requestAnimationFrame(() => {
                getElement('totalGold').textContent = formatNumber(currentGoldData.totalGold) + ' กรัม';
                getElement('totalValue').textContent = 'มูลค่า: ฿' + formatCurrency(totalValue);
                getElement('barGold').textContent = formatNumber(currentGoldData.balances.bar?.totalGold || 0) + ' กรัม';
                getElement('ornamentGold').textContent = formatNumber(currentGoldData.balances.ornament?.totalGold || 0) + ' กรัม';
            });
        }

        async function loadWalletData() {
            try {
                const API_URL = window.API_URL || '';
                if (!API_URL) {
                    loadWalletDataFallback();
                    return;
                }
                
                const data = await fetchData(`${API_URL}?action=getWallet&userId=${userData?.userId || 'test'}`);
                
                if (data.success) {
                    walletData.balance = data.balance || 0;
                    walletData.transactions = data.transactions || [];
                    updateWalletUI();
                } else {
                    loadWalletDataFallback();
                }
            } catch (error) {
                console.error('Error loading wallet data:', error);
                loadWalletDataFallback();
            }
        }

        function loadWalletDataFallback() {
            walletData = { balance: 0, transactions: [] };
            updateWalletUI();
        }

        function updateWalletUI() {
            getElement('walletBalance').textContent = '฿' + formatCurrency(walletData.balance);
            
            const walletHistory = getElement('walletHistory');
            walletHistory.innerHTML = '';

            if (walletData.transactions.length === 0) {
                walletHistory.innerHTML = '<p class="text-gray-500 text-center">ยังไม่มีรายการ</p>';
                return;
            }

            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            walletData.transactions.forEach(transaction => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                const typeColor = transaction.type === 'เติมเงิน' ? 'text-green-600' : 'text-red-600';
                const typeIcon = transaction.type === 'เติมเงิน' ? 'fa-plus-circle' : 'fa-minus-circle';
                const statusColor = transaction.status === 'สำเร็จ' ? 'text-green-500' :
                                   transaction.status === 'รอดำเนินการ' ? 'text-yellow-500' : 'text-red-500';
                div.innerHTML = `
                    <div>
                        <p class="font-semibold ${typeColor}">
                            <i class="fas ${typeIcon} mr-1"></i>
                            ${transaction.type}
                        </p>
                        <p class="text-sm text-gray-500">${transaction.date}</p>
                        <p class="text-xs ${statusColor}">${transaction.status}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold">฿${formatCurrency(transaction.amount)}</p>
                        <p class="text-sm text-gray-500">${transaction.bank || ''}</p>
                    </div>
                `;
                fragment.appendChild(div);
            });
            
            walletHistory.appendChild(fragment);
        }

        async function loadTransactions() {
            try {
                const API_URL = window.API_URL || '';
                if (!API_URL) {
                    loadTransactionsFallback();
                    return;
                }
                
                const data = await fetchData(`${API_URL}?action=getTransactions&userId=${userData?.userId || 'test'}`);
                
                if (data.success) {
                    updateTransactionsUI(data.transactions || []);
                } else {
                    loadTransactionsFallback();
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                loadTransactionsFallback();
            }
        }

        function loadTransactionsFallback() {
            updateTransactionsUI([]);
        }

        async function loadDataFallback() {
            // Load all fallback data
            loadGoldDataFallback();
            loadWalletDataFallback();
            loadTransactionsFallback();
        }

        function updateTransactionsUI(transactions) {
            const transactionList = getElement('transactionList');
            transactionList.innerHTML = '';
            
            if (transactions.length === 0) {
                transactionList.innerHTML = '<p class="text-gray-500 text-center">ยังไม่มีรายการ</p>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            transactions.forEach(transaction => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                const typeColor = transaction.type === 'ซื้อ' ? 'text-green-600' : 'text-red-600';
                const typeIcon = transaction.type === 'ซื้อ' ? 'fa-plus' : 'fa-minus';
                const goldTypeText = transaction.goldType === 'bar' ? 'ทองคำแท่ง' : 'ทองรูปพรรณ';
                div.innerHTML = `
                    <div>
                        <p class="font-semibold ${typeColor}">
                            <i class="fas ${typeIcon} mr-1"></i>
                            ${transaction.type} ${formatNumber(transaction.amount)} กรัม (${goldTypeText})
                        </p>
                        <p class="text-sm text-gray-500">${transaction.date}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold">฿${formatCurrency(transaction.price)}/บาท</p>
                        <p class="text-sm text-gray-500">฿${formatCurrency(transaction.total)}</p>
                    </div>
                `;
                fragment.appendChild(div);
            });
            
            transactionList.appendChild(fragment);
        }
    </script>

    <!-- Load remaining styles after initial render -->
    <link rel="stylesheet" href="styles.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="styles.css"></noscript>
</body>
</html>
